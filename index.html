<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Raindrops — a moment of calm</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; overflow: hidden; }
  body {
    background: #050810;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    min-height: 100dvh;
    font-family: 'Helvetica Neue', -apple-system, sans-serif;
    user-select: none;
    -webkit-user-select: none;
    touch-action: none;
    overflow: hidden;
  }
  canvas {
    border-radius: 12px;
    cursor: pointer;
    touch-action: none;
    box-shadow: 0 0 60px rgba(125,211,252,0.08);
  }
  .subtitle {
    color: rgba(255,255,255,0.12);
    font-size: 10px;
    margin-top: 8px;
    letter-spacing: 2px;
    text-align: center;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<p class="subtitle">RAINDROPS — a moment of calm</p>

<script>
const DROPS_TO_WIN = 30;
const DROP_INTERVAL = 280;
const GLOW_CHANCE = 0.15;
const HIT_RADIUS = 45;
const GAME_DURATION = 180;

const SCENES = {
  night: {
    name:"night", label:"Night",
    bg:["#0a0e1a","#111827"], cloudColor:"rgba(30,40,60,0.6)",
    dropColor:[120,160,200], glowColor:[125,211,252], glowInnerColor:[186,230,253],
    afterBg:["#fef3c7","#fde68a","#fbcfe8","#ddd6fe"], afterStops:[0,0.35,0.65,1],
    sunColor:"rgba(253,224,71,", sunPos:[0.75,0.2],
    arcColors:["#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#8b5cf6"],
    particleColors:["#f9a8d4","#fbbf24","#a78bfa","#34d399","#60a5fa","#fb923c","#f472b6"],
    afterText:"breathe", afterSubtext:"the storm has passed", afterTextColor:"120,80,150",
    btnColor:[125,211,252],
  },
  city: {
    name:"city", label:"City",
    bg:["#0f0a1e","#1a1025"], cloudColor:"rgba(40,25,60,0.5)",
    dropColor:[160,130,200], glowColor:[236,130,255], glowInnerColor:[245,180,255],
    afterBg:["#1a1025","#2d1b4e","#4a2070","#1a1025"], afterStops:[0,0.3,0.6,1],
    sunColor:"rgba(236,130,255,", sunPos:[0.5,0.15],
    arcColors:["#ff006e","#fb5607","#ffbe0b","#8338ec","#3a86ff","#06d6a0"],
    particleColors:["#ff006e","#fb5607","#ffbe0b","#8338ec","#3a86ff","#ff85a1","#06d6a0"],
    afterText:"city lights", afterSubtext:"the night is yours", afterTextColor:"200,160,255",
    btnColor:[236,130,255],
  },
  forest: {
    name:"forest", label:"Forest",
    bg:["#0a1a0e","#0f2614"], cloudColor:"rgba(20,40,25,0.55)",
    dropColor:[100,170,120], glowColor:[130,230,150], glowInnerColor:[180,245,190],
    afterBg:["#f0fdf4","#bbf7d0","#dcfce7","#fef9c3"], afterStops:[0,0.35,0.65,1],
    sunColor:"rgba(180,230,80,", sunPos:[0.6,0.18],
    arcColors:["#22c55e","#86efac","#fbbf24","#a3e635","#34d399","#6ee7b7"],
    particleColors:["#22c55e","#86efac","#fbbf24","#a3e635","#34d399","#bbf7d0","#fef08a"],
    afterText:"stillness", afterSubtext:"the forest breathes again", afterTextColor:"40,120,60",
    btnColor:[130,230,150],
  },
  ocean: {
    name:"ocean", label:"Ocean",
    bg:["#071a2e","#0c2440"], cloudColor:"rgba(20,35,55,0.55)",
    dropColor:[100,150,190], glowColor:[96,195,250], glowInnerColor:[160,220,255],
    afterBg:["#fff7ed","#fed7aa","#fecaca","#fce7f3"], afterStops:[0,0.3,0.65,1],
    sunColor:"rgba(253,186,116,", sunPos:[0.5,0.22],
    arcColors:["#f97316","#fb923c","#fbbf24","#f472b6","#a78bfa","#60a5fa"],
    particleColors:["#f97316","#fb923c","#fbbf24","#f472b6","#fda4af","#fed7aa","#93c5fd"],
    afterText:"horizons", afterSubtext:"the tide brings peace", afterTextColor:"180,100,60",
    btnColor:[96,195,250],
  },
  mountain: {
    name:"mountain", label:"Mountain",
    bg:["#111318","#1c1f2e"], cloudColor:"rgba(35,35,50,0.55)",
    dropColor:[140,150,170], glowColor:[180,200,230], glowInnerColor:[210,225,245],
    afterBg:["#fefce8","#fef08a","#fde68a","#fef3c7"], afterStops:[0,0.3,0.65,1],
    sunColor:"rgba(253,224,71,", sunPos:[0.65,0.15],
    arcColors:["#eab308","#f59e0b","#f97316","#ef4444","#ec4899","#a855f7"],
    particleColors:["#fef08a","#fde68a","#fbbf24","#f59e0b","#fca5a5","#d8b4fe","#fed7aa"],
    afterText:"summit", afterSubtext:"above the clouds now", afterTextColor:"140,100,30",
    btnColor:[180,200,230],
  },
};

const sceneKeys = Object.keys(SCENES);
let currentScene = SCENES.night;

const gs = {
  drops:[], catchParticles:[], ripples:[],
  score:0, phase:"menu",
  transitionProgress:0, rainbowParticles:[],
  lastDrop:0, timeLeft:GAME_DURATION,
  cloudOffset:0, rainbowAmbientStarted:false, menuPulse:0,
};

// === AUDIO ===
let audioCtx=null, audioStarted=false, rainSource=null, rainGain=null;

function startAudio() {
  if(audioStarted) return;
  try {
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    audioStarted=true;
    const bufSize=audioCtx.sampleRate*2;
    const buf=audioCtx.createBuffer(1,bufSize,audioCtx.sampleRate);
    const data=buf.getChannelData(0);
    let last=0;
    for(let i=0;i<bufSize;i++){const w=Math.random()*2-1;data[i]=(last+(0.02*w))/1.02;last=data[i];data[i]*=3.5;}
    rainSource=audioCtx.createBufferSource(); rainSource.buffer=buf; rainSource.loop=true;
    const filter=audioCtx.createBiquadFilter(); filter.type="lowpass"; filter.frequency.value=400;
    rainGain=audioCtx.createGain(); rainGain.gain.value=0.12;
    rainSource.connect(filter); filter.connect(rainGain); rainGain.connect(audioCtx.destination);
    rainSource.start();
  } catch(e){}
}

function playCatch() {
  if(!audioCtx)return;
  const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
  osc.frequency.value=[523,587,659,698,784,880,988][Math.floor(Math.random()*7)];
  osc.type="sine"; g.gain.setValueAtTime(0.15,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.6);
  osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+0.6);
}

function playComplete() {
  if(!audioCtx)return;
  [261.6,329.6,392,493.9].forEach((f,i)=>{
    const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
    osc.frequency.value=f; osc.type="sine";
    g.gain.setValueAtTime(0,audioCtx.currentTime+i*0.15);
    g.gain.linearRampToValueAtTime(0.08,audioCtx.currentTime+i*0.15+0.3);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+i*0.15+2);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(audioCtx.currentTime+i*0.15); osc.stop(audioCtx.currentTime+i*0.15+2);
  });
}

function fadeRain(target,dur) {
  if(!rainGain||!audioCtx)return;
  rainGain.gain.linearRampToValueAtTime(target,audioCtx.currentTime+dur);
}

// === CANVAS ===
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function getSize() {
  const maxW=Math.min(window.innerWidth*0.96, 500);
  const maxH=(window.innerHeight||document.documentElement.clientHeight)*0.82;
  let w=maxW, h=w/(9/16); // portrait-friendly ratio
  if(w > h*0.65) { w = maxW; h = w/(16/9); }
  if(h>maxH){h=maxH;w=h*(16/9);}
  if(w>maxW){w=maxW;h=w/(16/9);}
  return {w:Math.floor(w), h:Math.floor(h)};
}

function resize() {
  const {w,h}=getSize();
  canvas.width=w*2; canvas.height=h*2;
  canvas.style.width=w+"px"; canvas.style.height=h+"px";
  ctx.setTransform(2,0,0,2,0,0);
}
resize();
window.addEventListener("resize",resize);

// === BUTTON LAYOUT (responsive grid) ===
function getButtonLayout(cw, ch) {
  const gap = 10;
  // Try to fit in rows: 3+2 layout for narrow, 5 for wide
  const maxBtnW = 80;
  const testTotalW = sceneKeys.length * maxBtnW + (sceneKeys.length-1) * gap;

  let cols, btnW, btnH;
  if (testTotalW > cw * 0.9) {
    // Two rows: 3 top, 2 bottom
    cols = 3;
    btnW = Math.min(maxBtnW, Math.floor((cw * 0.85 - (cols-1)*gap) / cols));
    btnH = 34;
  } else {
    cols = 5;
    btnW = Math.min(maxBtnW, Math.floor((cw * 0.9 - (cols-1)*gap) / cols));
    btnH = 36;
  }

  const rows = Math.ceil(sceneKeys.length / cols);
  const positions = [];

  for (let i = 0; i < sceneKeys.length; i++) {
    const row = Math.floor(i / cols);
    const col = i % cols;
    const itemsInRow = Math.min(cols, sceneKeys.length - row * cols);
    const rowW = itemsInRow * btnW + (itemsInRow-1) * gap;
    const rowStartX = (cw - rowW) / 2;
    const totalGridH = rows * btnH + (rows-1) * gap;
    const gridStartY = ch/2 + 5;

    positions.push({
      x: rowStartX + col * (btnW + gap),
      y: gridStartY + row * (btnH + gap),
      w: btnW,
      h: btnH,
      key: sceneKeys[i],
    });
  }
  return positions;
}

// === HELPERS ===
function mkDrop(w,h) {
  const gl=Math.random()<GLOW_CHANCE;
  return {
    x:20+Math.random()*(w-40), y:-30,
    speed:gl?0.8+Math.random()*0.6:1.8+Math.random()*2,
    length:gl?20+Math.random()*10:8+Math.random()*12,
    opacity:gl?1:0.1+Math.random()*0.2,
    isGlowing:gl, pulsePhase:Math.random()*Math.PI*2,
    width:gl?3:1+Math.random(), caught:false, fadeOut:1,
  };
}
function mkCatchFx(x,y) {
  const ps=[], sc=currentScene;
  for(let i=0;i<16;i++){
    const a=(Math.PI*2*i)/16+Math.random()*0.3, s=2+Math.random()*4;
    const c=Math.random()>0.5?`rgb(${sc.glowColor})`:`rgb(${sc.glowInnerColor})`;
    ps.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-2,life:1,size:2+Math.random()*4,color:c});
  }
  return ps;
}
function mkRipple(x,y){return{x,y,radius:5,opacity:0.6,speed:1.5};}
function mkRainbowPs(w,h) {
  const ps=[];
  for(let i=0;i<150;i++){
    ps.push({
      x:Math.random()*w, y:Math.random()*h, size:3+Math.random()*8,
      color:currentScene.particleColors[Math.floor(Math.random()*currentScene.particleColors.length)],
      speed:0.3+Math.random()*0.7, wobble:Math.random()*Math.PI*2,
      wobbleSpeed:0.01+Math.random()*0.02,
      opacity:0, targetOpacity:0.4+Math.random()*0.5,
      fadeSpeed:0.005+Math.random()*0.01,
      shape:Math.random()>0.5?"circle":"diamond",
    });
  }
  return ps;
}

// === INPUT ===
function getPos(e) {
  const rect=canvas.getBoundingClientRect();
  const sx=(canvas.width/2)/rect.width, sy=(canvas.height/2)/rect.height;
  const cx=e.touches?e.touches[0].clientX:e.clientX;
  const cy=e.touches?e.touches[0].clientY:e.clientY;
  return {x:(cx-rect.left)*sx, y:(cy-rect.top)*sy};
}

function handleTap(e) {
  e.preventDefault(); startAudio();
  const {w:cw,h:ch}=getSize();

  if(gs.phase==="menu"){gs.phase="scenePicker";return;}

  if(gs.phase==="scenePicker") {
    const {x,y}=getPos(e);
    const btns = getButtonLayout(cw, ch);
    for(const b of btns) {
      if(x>=b.x && x<=b.x+b.w && y>=b.y && y<=b.y+b.h) {
        currentScene=SCENES[b.key];
        gs.phase="playing"; gs.score=0; gs.timeLeft=GAME_DURATION;
        gs.drops=[]; gs.catchParticles=[]; gs.ripples=[];
        gs.rainbowAmbientStarted=false; gs.rainbowParticles=[];
        fadeRain(0.12,1); lastTick=Date.now();
        return;
      }
    }
    return;
  }

  if(gs.phase==="rainbow") {
    gs.phase="scenePicker"; gs.score=0; gs.transitionProgress=0;
    gs.rainbowParticles=[]; gs.drops=[]; gs.rainbowAmbientStarted=false;
    fadeRain(0.12,1); return;
  }

  if(gs.phase!=="playing") return;

  const {x,y}=getPos(e);
  let best=Infinity, bestIdx=-1;
  for(let i=0;i<gs.drops.length;i++){
    const d=gs.drops[i]; if(!d.isGlowing||d.caught)continue;
    const dist=Math.hypot(x-d.x,y-d.y);
    if(dist<HIT_RADIUS&&dist<best){best=dist;bestIdx=i;}
  }
  if(bestIdx>=0){
    const d=gs.drops[bestIdx]; d.caught=true; gs.score++;
    gs.catchParticles.push(...mkCatchFx(d.x,d.y));
    gs.ripples.push(mkRipple(d.x,d.y)); playCatch();
    if(gs.score>=DROPS_TO_WIN){gs.phase="transition";gs.transitionProgress=0;playComplete();}
  } else { gs.ripples.push(mkRipple(x,y)); }
}

canvas.addEventListener("click",handleTap);
canvas.addEventListener("touchstart",handleTap,{passive:false});

// === DRAWING ===
function drawCloud(cx,cy,w,h,op) {
  ctx.save(); ctx.globalAlpha=op; ctx.fillStyle=currentScene.cloudColor;
  ctx.beginPath(); ctx.ellipse(cx,cy,w*0.5,h*0.4,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(cx-w*0.25,cy+h*0.1,w*0.35,h*0.3,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(cx+w*0.3,cy+h*0.05,w*0.3,h*0.32,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawDrop(d) {
  const sc=currentScene;
  ctx.save();
  if(d.isGlowing&&!d.caught){
    d.pulsePhase+=0.05; const p=0.6+Math.sin(d.pulsePhase)*0.4;
    const og=ctx.createRadialGradient(d.x,d.y,0,d.x,d.y,35);
    og.addColorStop(0,`rgba(${sc.glowColor},${0.25*p})`);
    og.addColorStop(0.4,`rgba(${sc.glowColor},${0.1*p})`);
    og.addColorStop(1,`rgba(${sc.glowColor},0)`);
    ctx.fillStyle=og; ctx.beginPath(); ctx.arc(d.x,d.y,35,0,Math.PI*2); ctx.fill();
    const ig=ctx.createRadialGradient(d.x,d.y,0,d.x,d.y,15);
    ig.addColorStop(0,`rgba(${sc.glowInnerColor},${0.5*p})`);
    ig.addColorStop(1,`rgba(${sc.glowColor},${0.15*p})`);
    ctx.fillStyle=ig; ctx.beginPath(); ctx.arc(d.x,d.y,15,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=`rgba(${sc.glowInnerColor},${0.9*d.fadeOut})`; ctx.lineWidth=d.width; ctx.lineCap="round";
    ctx.beginPath(); ctx.moveTo(d.x,d.y-d.length/2); ctx.lineTo(d.x,d.y+d.length/2); ctx.stroke();
    ctx.fillStyle=`rgba(255,255,255,${0.9*p*d.fadeOut})`;
    ctx.beginPath(); ctx.arc(d.x,d.y,3,0,Math.PI*2); ctx.fill();
  } else {
    ctx.strokeStyle=`rgba(${sc.dropColor},${d.opacity*d.fadeOut})`; ctx.lineWidth=d.width; ctx.lineCap="round";
    ctx.beginPath(); ctx.moveTo(d.x,d.y-d.length/2); ctx.lineTo(d.x,d.y+d.length/2); ctx.stroke();
  }
  ctx.restore();
}

function drawParticle(p) {
  ctx.save(); ctx.globalAlpha=p.opacity||1; ctx.fillStyle=p.color;
  if(p.shape==="circle"){ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();}
  else{ctx.translate(p.x,p.y);ctx.rotate(Math.PI/4);ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);}
  ctx.restore();
}

function drawScenePicker(cw,ch) {
  const bg=ctx.createLinearGradient(0,0,0,ch);
  bg.addColorStop(0,"#0a0e1a"); bg.addColorStop(1,"#111827");
  ctx.fillStyle=bg; ctx.fillRect(0,0,cw,ch);

  gs.cloudOffset+=0.15;
  drawCloud((gs.cloudOffset%(cw+200))-100,40,180,50,0.3);
  drawCloud(((gs.cloudOffset*0.7+300)%(cw+200))-100,25,140,40,0.2);

  const now=Date.now();
  if(now-gs.lastDrop>500){
    const d=mkDrop(cw,ch); d.isGlowing=false; d.opacity=0.06+Math.random()*0.08;
    gs.drops.push(d); gs.lastDrop=now;
  }
  for(let i=gs.drops.length-1;i>=0;i--){
    const d=gs.drops[i]; d.y+=d.speed;
    if(d.y>ch+30){gs.drops.splice(i,1);continue;}
    ctx.save(); ctx.strokeStyle=`rgba(120,160,200,${d.opacity})`; ctx.lineWidth=d.width; ctx.lineCap="round";
    ctx.beginPath(); ctx.moveTo(d.x,d.y-d.length/2); ctx.lineTo(d.x,d.y+d.length/2); ctx.stroke(); ctx.restore();
  }

  // Title
  ctx.fillStyle="rgba(255,255,255,0.7)"; ctx.font="600 24px 'Helvetica Neue',sans-serif";
  ctx.textAlign="center"; ctx.fillText("raindrops",cw/2,ch/2-45);
  ctx.fillStyle="rgba(255,255,255,0.25)"; ctx.font="11px 'Helvetica Neue',sans-serif";
  ctx.fillText("choose your moment",cw/2,ch/2-20);

  // Buttons
  const btns = getButtonLayout(cw, ch);
  btns.forEach(b => {
    const sc = SCENES[b.key];
    const c = sc.btnColor;
    ctx.fillStyle=`rgba(${c[0]},${c[1]},${c[2]},0.08)`;
    ctx.beginPath(); ctx.roundRect(b.x,b.y,b.w,b.h,8); ctx.fill();
    ctx.strokeStyle=`rgba(${c[0]},${c[1]},${c[2]},0.3)`;
    ctx.lineWidth=1;
    ctx.beginPath(); ctx.roundRect(b.x,b.y,b.w,b.h,8); ctx.stroke();
    ctx.fillStyle=`rgba(${c[0]},${c[1]},${c[2]},0.7)`;
    ctx.font="600 11px 'Helvetica Neue',sans-serif";
    ctx.textAlign="center";
    ctx.fillText(sc.label, b.x+b.w/2, b.y+b.h/2+4);
  });
}

// === GAME LOOP ===
let lastTick=Date.now();

function loop() {
  const now=Date.now();
  const {w:cw,h:ch}=getSize();
  const sc=currentScene;

  if(gs.phase==="scenePicker"){drawScenePicker(cw,ch);requestAnimationFrame(loop);return;}

  if(gs.phase==="playing"){
    const delta=now-lastTick;
    if(delta>=1000){
      gs.timeLeft=Math.max(0,gs.timeLeft-Math.floor(delta/1000));
      lastTick=now-(delta%1000);
      if(gs.timeLeft<=0){gs.phase="transition";gs.transitionProgress=0;playComplete();}
    }
  }

  // BG
  const bg=ctx.createLinearGradient(0,0,0,ch);
  bg.addColorStop(0,sc.bg[0]); bg.addColorStop(1,sc.bg[1]);
  ctx.fillStyle=bg; ctx.fillRect(0,0,cw,ch);

  if(gs.phase==="menu"||gs.phase==="playing"){
    gs.cloudOffset+=0.15;
    drawCloud((gs.cloudOffset%(cw+200))-100,40,180,50,0.4);
    drawCloud(((gs.cloudOffset*0.7+300)%(cw+200))-100,25,140,40,0.3);
    drawCloud(((gs.cloudOffset*0.5+150)%(cw+200))-100,55,160,45,0.35);

    if(gs.phase==="playing"&&now-gs.lastDrop>DROP_INTERVAL){gs.drops.push(mkDrop(cw,ch));gs.lastDrop=now;}
    if(gs.phase==="menu"&&now-gs.lastDrop>400){
      const d=mkDrop(cw,ch);d.isGlowing=false;d.opacity=0.08+Math.random()*0.12;gs.drops.push(d);gs.lastDrop=now;
    }

    for(let i=gs.drops.length-1;i>=0;i--){
      const d=gs.drops[i];d.y+=d.speed;
      if(d.caught){d.fadeOut-=0.1;if(d.fadeOut<=0){gs.drops.splice(i,1);continue;}}
      if(d.y>ch+30){gs.drops.splice(i,1);continue;}
      drawDrop(d);
    }

    for(let i=gs.ripples.length-1;i>=0;i--){
      const r=gs.ripples[i];r.radius+=r.speed;r.opacity-=0.015;
      if(r.opacity<=0){gs.ripples.splice(i,1);continue;}
      ctx.save();ctx.strokeStyle=`rgba(${sc.glowColor},${r.opacity})`;ctx.lineWidth=1.5;
      ctx.beginPath();ctx.arc(r.x,r.y,r.radius,0,Math.PI*2);ctx.stroke();ctx.restore();
    }

    for(let i=gs.catchParticles.length-1;i>=0;i--){
      const p=gs.catchParticles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.05;p.life-=0.02;
      if(p.life<=0){gs.catchParticles.splice(i,1);continue;}
      ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.color;
      ctx.beginPath();ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);ctx.fill();ctx.restore();
    }

    if(gs.phase==="playing"){
      const bw=cw*0.6,bh=6,bx=(cw-bw)/2,by=ch-30;
      const prog=Math.min(gs.score/DROPS_TO_WIN,1);
      ctx.fillStyle="rgba(255,255,255,0.08)";
      ctx.beginPath();ctx.roundRect(bx,by,bw,bh,3);ctx.fill();
      if(prog>0){
        const fg=ctx.createLinearGradient(bx,0,bx+bw*prog,0);
        fg.addColorStop(0,`rgba(${sc.glowColor},0.5)`);fg.addColorStop(1,`rgba(${sc.glowInnerColor},0.8)`);
        ctx.fillStyle=fg;ctx.beginPath();ctx.roundRect(bx,by,bw*prog,bh,3);ctx.fill();
        ctx.shadowColor=`rgba(${sc.glowColor},0.5)`;ctx.shadowBlur=8;
        ctx.beginPath();ctx.roundRect(bx,by,bw*prog,bh,3);ctx.fill();ctx.shadowBlur=0;
      }
      ctx.fillStyle="rgba(255,255,255,0.5)";ctx.font="11px 'Helvetica Neue',sans-serif";
      ctx.textAlign="center";ctx.fillText(`${gs.score} / ${DROPS_TO_WIN}`,cw/2,by-8);
      const m=Math.floor(gs.timeLeft/60),s=gs.timeLeft%60;
      ctx.fillStyle="rgba(255,255,255,0.2)";ctx.font="10px 'Helvetica Neue',sans-serif";
      ctx.textAlign="right";ctx.fillText(`${m}:${s.toString().padStart(2,"0")}`,cw-15,20);
    }

    if(gs.phase==="menu"){
      gs.menuPulse+=0.02;
      ctx.fillStyle="rgba(255,255,255,0.7)";ctx.font="600 28px 'Helvetica Neue',sans-serif";
      ctx.textAlign="center";ctx.fillText("raindrops",cw/2,ch/2-20);
      ctx.fillStyle=`rgba(125,211,252,${0.35+Math.sin(gs.menuPulse)*0.15})`;
      ctx.font="12px 'Helvetica Neue',sans-serif";ctx.fillText("tap to begin",cw/2,ch/2+15);
      ctx.fillStyle="rgba(255,255,255,0.2)";ctx.font="10px 'Helvetica Neue',sans-serif";
      ctx.fillText("catch the glowing drops",cw/2,ch/2+35);
    }
  }

  // Transition
  if(gs.phase==="transition"){
    gs.transitionProgress+=0.006;
    const t=Math.min(gs.transitionProgress,1);
    if(!gs.rainbowAmbientStarted&&t>0.4){fadeRain(0,3);gs.rainbowAmbientStarted=true;}

    const fr1=parseInt(sc.bg[0].slice(1,3),16),fg1=parseInt(sc.bg[0].slice(3,5),16),fb1=parseInt(sc.bg[0].slice(5,7),16);
    const tr1=parseInt(sc.afterBg[0].slice(1,3),16)||254,tg1=parseInt(sc.afterBg[0].slice(3,5),16)||243,tb1=parseInt(sc.afterBg[0].slice(5,7),16)||199;
    const fr2=parseInt(sc.bg[1].slice(1,3),16),fg2=parseInt(sc.bg[1].slice(3,5),16),fb2=parseInt(sc.bg[1].slice(5,7),16);
    const last=sc.afterBg[sc.afterBg.length-1];
    const tr2=parseInt(last.slice(1,3),16),tg2=parseInt(last.slice(3,5),16),tb2=parseInt(last.slice(5,7),16);

    const bg2=ctx.createLinearGradient(0,0,0,ch);
    bg2.addColorStop(0,`rgb(${Math.floor(fr1+(tr1-fr1)*t)},${Math.floor(fg1+(tg1-fg1)*t)},${Math.floor(fb1+(tb1-fb1)*t)})`);
    bg2.addColorStop(1,`rgb(${Math.floor(fr2+(tr2-fr2)*t)},${Math.floor(fg2+(tg2-fg2)*t)},${Math.floor(fb2+(tb2-fb2)*t)})`);
    ctx.fillStyle=bg2;ctx.fillRect(0,0,cw,ch);

    for(let i=gs.drops.length-1;i>=0;i--){
      const d=gs.drops[i];d.opacity*=0.96;d.y+=d.speed*0.3;
      if(d.opacity<0.005){gs.drops.splice(i,1);continue;}
      ctx.save();ctx.strokeStyle=`rgba(200,220,240,${d.opacity})`;ctx.lineWidth=d.width;ctx.lineCap="round";
      ctx.beginPath();ctx.moveTo(d.x,d.y-d.length/2);ctx.lineTo(d.x,d.y+d.length/2);ctx.stroke();ctx.restore();
    }

    if(t>0.3){
      if(gs.rainbowParticles.length===0) gs.rainbowParticles=mkRainbowPs(cw,ch);
      const po=(t-0.3)/0.7;
      gs.rainbowParticles.forEach(rp=>{
        rp.wobble+=rp.wobbleSpeed;rp.y-=rp.speed*0.5;rp.x+=Math.sin(rp.wobble)*0.5;
        if(rp.y<-10)rp.y=ch+10;
        ctx.save();ctx.globalAlpha=rp.targetOpacity*po*0.6;drawParticle(rp);ctx.restore();
      });
    }

    if(t>0.6){
      ctx.save();ctx.globalAlpha=Math.min((t-0.6)/0.3,1)*0.5;
      ctx.fillStyle=`rgba(${sc.afterTextColor},1)`;ctx.font="600 22px 'Helvetica Neue',sans-serif";
      ctx.textAlign="center";ctx.fillText(sc.afterText,cw/2,ch/2-10);ctx.restore();
    }

    if(gs.transitionProgress>=1.3) gs.phase="rainbow";
  }

  // Rainbow
  if(gs.phase==="rainbow"){
    const rg=ctx.createLinearGradient(0,0,0,ch);
    sc.afterBg.forEach((c,i)=>rg.addColorStop(sc.afterStops[i],c));
    ctx.fillStyle=rg;ctx.fillRect(0,0,cw,ch);

    const [sxp,syp]=sc.sunPos;
    const sx=cw*sxp,sy=ch*syp;
    const sg=ctx.createRadialGradient(sx,sy,0,sx,sy,90);
    sg.addColorStop(0,sc.sunColor+"0.7)");sg.addColorStop(0.3,sc.sunColor+"0.25)");sg.addColorStop(1,sc.sunColor+"0)");
    ctx.fillStyle=sg;ctx.beginPath();ctx.arc(sx,sy,90,0,Math.PI*2);ctx.fill();
    ctx.fillStyle="rgba(255,255,255,0.85)";ctx.beginPath();ctx.arc(sx,sy,22,0,Math.PI*2);ctx.fill();

    sc.arcColors.forEach((c,i)=>{
      ctx.save();ctx.strokeStyle=c;ctx.globalAlpha=0.35;ctx.lineWidth=10;
      ctx.beginPath();ctx.arc(cw*0.3,ch*0.95,130+i*12,Math.PI,Math.PI*1.75);ctx.stroke();ctx.restore();
    });

    if(gs.rainbowParticles.length===0) gs.rainbowParticles=mkRainbowPs(cw,ch);
    gs.rainbowParticles.forEach(rp=>{
      rp.wobble+=rp.wobbleSpeed;rp.y-=rp.speed*0.3;rp.x+=Math.sin(rp.wobble)*0.3;
      if(rp.opacity<rp.targetOpacity)rp.opacity+=rp.fadeSpeed;
      if(rp.y<-10){rp.y=ch+10;rp.x=Math.random()*cw;}
      drawParticle(rp);
    });

    ctx.fillStyle=`rgba(${sc.afterTextColor},0.55)`;ctx.font="600 22px 'Helvetica Neue',sans-serif";
    ctx.textAlign="center";ctx.fillText(sc.afterText,cw/2,ch/2-10);
    ctx.fillStyle=`rgba(${sc.afterTextColor},0.3)`;ctx.font="11px 'Helvetica Neue',sans-serif";
    ctx.fillText(sc.afterSubtext,cw/2,ch/2+15);
    ctx.fillStyle=`rgba(${sc.afterTextColor},0.2)`;ctx.font="10px 'Helvetica Neue',sans-serif";
    ctx.fillText("tap to continue",cw/2,ch-25);
  }

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>
