<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Raindrops — A MOMENT IN TIME</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{background:#050810;display:flex;flex-direction:column;align-items:center;justify-content:center;
min-height:100vh;min-height:100dvh;font-family:'Helvetica Neue',-apple-system,sans-serif;
user-select:none;-webkit-user-select:none;touch-action:none;overflow:hidden;}
canvas{border-radius:12px;cursor:pointer;touch-action:none;box-shadow:0 0 60px rgba(180,140,255,0.06);}
.sub{color:rgba(255,255,255,0.25);font-size:12px;margin-top:10px;letter-spacing:2px;text-align:center;}
</style>
</head>
<body>
<canvas id="g"></canvas>
<p class="sub">RAINDROPS — A MONENT IN TIME</p>
<script>
// === CONFIG ===
const DROPS_TO_WIN = 30;
const RAIN_INT = 45;          // regular rain spawn interval (dense)
const GLOW_MIN_GAP = 3000;    // minimum ms between glowing drops
const GLOW_MAX_GAP = 6000;    // maximum ms between glowing drops
const HIT_R = 45;
const DURATION = 180;          // 3 minutes — longer, more relaxed
const DENSE = 6;               // regular drops per spawn

const QUOTES = [
  "Be still. The rain knows when to stop.",
  "Even cities sleep eventually.",
  "The noise fades. You remain.",
  "Somewhere above, stars are waiting.",
  "Let the rain wash the day away.",
  "You found quiet in the chaos.",
  "The city breathes between the drops.",
  "Not every moment needs a purpose.",
  "Some storms are meant to be watched.",
  "Rest here. The world can wait.",
];

// === AUDIO ===
let actx=null,started=false,rainSrc=null,rainG=null;

function initAudio(){
  if(started)return;try{
  actx=new(window.AudioContext||window.webkitAudioContext)();started=true;
  const sr=actx.sampleRate,len=sr*3;
  // Layer 1: Heavy rain base (brown noise, higher cutoff)
  const buf1=actx.createBuffer(2,len,sr);
  for(let ch=0;ch<2;ch++){const d=buf1.getChannelData(ch);let last=0;
    for(let i=0;i<len;i++){const w=Math.random()*2-1;d[i]=(last+(0.02*w))/1.02;last=d[i];d[i]*=3.5;}}
  const src1=actx.createBufferSource();src1.buffer=buf1;src1.loop=true;
  const f1=actx.createBiquadFilter();f1.type="lowpass";f1.frequency.value=1800;
  const g1=actx.createGain();g1.gain.value=0.14;
  src1.connect(f1);f1.connect(g1);g1.connect(actx.destination);src1.start();
  // Layer 2: Rain patter (white noise, bandpassed for that crackle)
  const buf2=actx.createBuffer(2,len,sr);
  for(let ch=0;ch<2;ch++){const d=buf2.getChannelData(ch);
    for(let i=0;i<len;i++)d[i]=(Math.random()*2-1);}
  const src2=actx.createBufferSource();src2.buffer=buf2;src2.loop=true;
  const f2=actx.createBiquadFilter();f2.type="bandpass";f2.frequency.value=3500;f2.Q.value=0.8;
  const g2=actx.createGain();g2.gain.value=0.08;
  src2.connect(f2);f2.connect(g2);g2.connect(actx.destination);src2.start();
  // Layer 3: Rain drops / splatter (high freq patter)
  const buf3=actx.createBuffer(1,len,sr);
  const d3=buf3.getChannelData(0);
  for(let i=0;i<len;i++){d3[i]=Math.random()>0.98?(Math.random()*2-1)*0.5:0;}
  const src3=actx.createBufferSource();src3.buffer=buf3;src3.loop=true;
  const f3=actx.createBiquadFilter();f3.type="highpass";f3.frequency.value=2000;
  const g3=actx.createGain();g3.gain.value=0.06;
  src3.connect(f3);f3.connect(g3);g3.connect(actx.destination);src3.start();
  // Master rain gain for fading
  rainG=actx.createGain();rainG.gain.value=1.0;
  g1.disconnect();g2.disconnect();g3.disconnect();
  g1.connect(rainG);g2.connect(rainG);g3.connect(rainG);
  rainG.connect(actx.destination);
  rainSrc=src1;
  }catch(e){}}

function chime(){
  if(!actx)return;
  const freqs=[1568,2093,2637,3136,3520];
  const f=freqs[Math.floor(Math.random()*freqs.length)];
  [f,f*1.002].forEach((freq,i)=>{
    const o=actx.createOscillator(),g=actx.createGain();
    o.type="sine";o.frequency.value=freq;
    g.gain.setValueAtTime(i===0?0.12:0.06,actx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.8);
    o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+0.8);
  });
  const nb=actx.createBufferSource();
  const nBuf=actx.createBuffer(1,actx.sampleRate*0.05,actx.sampleRate);
  const nd=nBuf.getChannelData(0);for(let i=0;i<nd.length;i++)nd[i]=(Math.random()*2-1)*0.3;
  nb.buffer=nBuf;
  const nf=actx.createBiquadFilter();nf.type="bandpass";nf.frequency.value=4000;nf.Q.value=5;
  const ng=actx.createGain();ng.gain.setValueAtTime(0.08,actx.currentTime);
  ng.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.15);
  nb.connect(nf);nf.connect(ng);ng.connect(actx.destination);nb.start();
}

function playEnd(){
  if(!actx)return;
  if(rainG)rainG.gain.linearRampToValueAtTime(0.04,actx.currentTime+5);
  [261.6,329.6,392,523.2].forEach((f,i)=>{
    const o=actx.createOscillator(),g=actx.createGain();
    o.type="sine";o.frequency.value=f;
    g.gain.setValueAtTime(0,actx.currentTime+i*0.3);
    g.gain.linearRampToValueAtTime(0.05,actx.currentTime+i*0.3+0.6);
    g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+i*0.3+4);
    o.connect(g);g.connect(actx.destination);o.start(actx.currentTime+i*0.3);o.stop(actx.currentTime+i*0.3+4);
  });
}

function resetRain(){if(rainG&&actx)rainG.gain.linearRampToValueAtTime(1.0,actx.currentTime+1);}
// === CANVAS ===
const cv=document.getElementById("g"),c=cv.getContext("2d");
function getSize(){
  const aspect = 16 / 9;

  const vw = window.innerWidth;
  const vh = window.visualViewport
    ? window.visualViewport.height
    : window.innerHeight;

  let w = vw * 0.98;
  let h = vh * 0.90;

  if (w / h > aspect) {
    w = h * aspect;
  } else {
    h = w / aspect;
  }

  return {
    w: Math.floor(w),
    h: Math.floor(h)
  };
}
function resize(){const{w,h}=getSize();cv.width=w*2;cv.height=h*2;cv.style.width=w+"px";cv.style.height=h+"px";c.setTransform(2,0,0,2,0,0);}
resize();window.addEventListener("resize",resize);

// === SKYLINE ===
function buildSkyline(w,h){
  const bs=[];let x=-5;
  while(x<w+20){
    const bw=14+Math.random()*38;
    const bh=h*0.12+Math.random()*h*0.48;
    const ant=Math.random()>0.7;
    const wins=[];
    const wC=Math.floor(bw/8),wR=Math.floor(bh/12);
   for (let r = 1; r < wR; r++) {
  for (let cl = 0; cl < wC; cl++) {
    if (Math.random() > 0.75) {
      wins.push({
        rx: 3 + cl * (bw / wC),
        ry: r * 12,
        lit: Math.random() > 0.75,
        flicker: Math.random() > 0.995,
        fSpd: 0.001 + Math.random() * 0.002,
        fPh: Math.random() * Math.PI * 2,
      });
    }
  }
}
    bs.push({x,w:bw,h:bh,ant,aH:10+Math.random()*20,wins});
    x+=bw+2+Math.random()*5;
  }
  return bs;
}
let sky=null;

function drawSky(w,h,t){
  if(!sky)sky=buildSkyline(w,h);
  const by=h;
  // City glow
  const gl=c.createRadialGradient(w/2,h,0,w/2,h,h*0.8);
  gl.addColorStop(0,"rgba(60,30,80,0.12)");gl.addColorStop(0.5,"rgba(40,20,60,0.05)");gl.addColorStop(1,"rgba(0,0,0,0)");
  c.fillStyle=gl;c.fillRect(0,0,w,h);

  sky.forEach(b=>{
    c.fillStyle="rgba(8,6,14,0.95)";c.fillRect(b.x,by-b.h,b.w,b.h);
    c.strokeStyle="rgba(60,40,80,0.12)";c.lineWidth=0.5;c.strokeRect(b.x,by-b.h,b.w,b.h);
    if(b.ant){
      const ax=b.x+b.w/2;
      c.strokeStyle="rgba(40,30,60,0.5)";c.lineWidth=1;
      c.beginPath();c.moveTo(ax,by-b.h);c.lineTo(ax,by-b.h-b.aH);c.stroke();
      if(Math.sin(t*0.003+b.x)>0.3){
        c.fillStyle="rgba(255,50,50,0.6)";c.beginPath();c.arc(ax,by-b.h-b.aH,1.5,0,Math.PI*2);c.fill();
        const rg=c.createRadialGradient(ax,by-b.h-b.aH,0,ax,by-b.h-b.aH,8);
        rg.addColorStop(0,"rgba(255,50,50,0.15)");rg.addColorStop(1,"rgba(255,50,50,0)");
        c.fillStyle=rg;c.beginPath();c.arc(ax,by-b.h-b.aH,8,0,Math.PI*2);c.fill();
      }
    }
    b.wins.forEach(win=>{
      let a=win.lit?0.6:0.08;
      if(win.flicker)a*=0.5+0.5*Math.sin(t*win.fSpd+win.fPh);
      if(win.lit){
        const wx=b.x+win.rx,wy=by-b.h+win.ry;
        c.fillStyle=`rgba(255,220,140,${a*0.3})`;c.fillRect(wx-1,wy-1,5,5);
        c.fillStyle=`rgba(255,200,100,${a})`;c.fillRect(wx,wy,3,3);
      } else {
        c.fillStyle=`rgba(30,25,45,${a})`;c.fillRect(b.x+win.rx,by-b.h+win.ry,3,3);
      }
    });
  });
}

// === GAME STATE ===
const gs={
  drops:[],catchPs:[],ripples:[],
  score:0,phase:"menu",timeLeft:DURATION,
  lastRain:0,nextGlow:0,lastGlowTime:0,
  cloudOff:0,menuPulse:0,
  endT:0,endQuote:"",
  dimAlpha:0,rainFaded:false,rbPs:null,
};

// Schedule next glow drop
function scheduleGlow(){
  gs.nextGlow=Date.now()+GLOW_MIN_GAP+Math.random()*(GLOW_MAX_GAP-GLOW_MIN_GAP);
}

function mkDrop(w,h,forceGlow){
  const gl=forceGlow||false;
  return{
    x:Math.random()*w,y:-10-Math.random()*50,
    speed:gl?1.2+Math.random()*0.5:3.5+Math.random()*3.5,
    length:gl?18+Math.random()*10:3+Math.random()*8,
    opacity:gl?1:0.08+Math.random()*0.18,
    isGlowing:gl,pulsePhase:Math.random()*Math.PI*2,
    width:gl?2.5:0.5+Math.random()*0.7,
    caught:false,fadeOut:1,
    drift:(Math.random()-0.5)*0.4,
  };
}

function mkFx(x,y){
  const ps=[];
  for(let i=0;i<14;i++){
    const a=(Math.PI*2*i)/14+Math.random()*0.3,s=2+Math.random()*3;
    ps.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,life:1,size:1.5+Math.random()*3,
      color:Math.random()>0.5?"rgba(236,210,255,":"rgba(200,175,255,"});
  }
  return ps;
}

function mkRip(x,y){return{x,y,radius:3,opacity:0.45,speed:1};}

// === INPUT ===
function getPos(e){
  const r=cv.getBoundingClientRect();
  const sx=(cv.width/2)/r.width,sy=(cv.height/2)/r.height;
  const px=e.touches?e.touches[0].clientX:e.clientX;
  const py=e.touches?e.touches[0].clientY:e.clientY;
  return{x:(px-r.left)*sx,y:(py-r.top)*sy};
}

function tap(e){
  e.preventDefault();initAudio();

  if(gs.phase==="menu"){
    gs.phase="playing";gs.score=0;gs.timeLeft=DURATION;
    gs.drops=[];gs.catchPs=[];gs.ripples=[];
    gs.endT=0;gs.dimAlpha=0;gs.rainFaded=false;gs.rbPs=null;
    sky=null;scheduleGlow();
    resetRain();lastTick=Date.now();return;
  }

  if(gs.phase==="quote"){
    gs.phase="menu";gs.score=0;sky=null;
    gs.dimAlpha=0;gs.rainFaded=false;gs.rbPs=null;resetRain();return;
  }

  if(gs.phase!=="playing")return;

  const{x,y}=getPos(e);
  let best=Infinity,bi=-1;
  for(let i=0;i<gs.drops.length;i++){
    const d=gs.drops[i];if(!d.isGlowing||d.caught)continue;
    const dist=Math.hypot(x-d.x,y-d.y);
    if(dist<HIT_R&&dist<best){best=dist;bi=i;}
  }
  if(bi>=0){
    const d=gs.drops[bi];d.caught=true;gs.score++;
    gs.catchPs.push(...mkFx(d.x,d.y));
    gs.ripples.push(mkRip(d.x,d.y));chime();
    if(gs.score>=DROPS_TO_WIN){
      gs.phase="ending";gs.endT=0;
      gs.endQuote=QUOTES[Math.floor(Math.random()*QUOTES.length)];
      playEnd();
    }
  } else {
    gs.ripples.push(mkRip(x,y));
  }
}

cv.addEventListener("click",tap);
cv.addEventListener("touchstart",tap,{passive:false});

// === DRAW DROP ===
function drawDrop(d){
  c.save();
  if(d.isGlowing&&!d.caught){
    d.pulsePhase+=0.04;const p=0.6+Math.sin(d.pulsePhase)*0.4;
    const og=c.createRadialGradient(d.x,d.y,0,d.x,d.y,32);
    og.addColorStop(0,`rgba(200,160,255,${0.22*p})`);og.addColorStop(0.4,`rgba(180,140,240,${0.08*p})`);og.addColorStop(1,"rgba(180,140,240,0)");
    c.fillStyle=og;c.beginPath();c.arc(d.x,d.y,32,0,Math.PI*2);c.fill();
    const ig=c.createRadialGradient(d.x,d.y,0,d.x,d.y,12);
    ig.addColorStop(0,`rgba(225,210,255,${0.45*p})`);ig.addColorStop(1,`rgba(180,150,240,${0.12*p})`);
    c.fillStyle=ig;c.beginPath();c.arc(d.x,d.y,12,0,Math.PI*2);c.fill();
    c.strokeStyle=`rgba(225,210,255,${0.8*d.fadeOut})`;c.lineWidth=d.width;c.lineCap="round";
    c.beginPath();c.moveTo(d.x,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();
    c.fillStyle=`rgba(255,255,255,${0.85*p*d.fadeOut})`;
    c.beginPath();c.arc(d.x,d.y,2.5,0,Math.PI*2);c.fill();
  } else {
    c.strokeStyle=`rgba(150,145,175,${d.opacity*d.fadeOut})`;c.lineWidth=d.width;c.lineCap="round";
    c.beginPath();c.moveTo(d.x+d.drift*5,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();
  }
  c.restore();
}

// === MAIN LOOP ===
let lastTick=Date.now();

function loop(){
  const now=Date.now(),{w:cw,h:ch}=getSize();

  // Timer
  if(gs.phase==="playing"){
    const dt=now-lastTick;
    if(dt>=1000){
      gs.timeLeft=Math.max(0,gs.timeLeft-Math.floor(dt/1000));
      lastTick=now-(dt%1000);
      if(gs.timeLeft<=0){
        gs.phase="ending";gs.endT=0;
        gs.endQuote=QUOTES[Math.floor(Math.random()*QUOTES.length)];
        playEnd();
      }
    }
  }

  // === BG ===
  const bg=c.createLinearGradient(0,0,0,ch);
  bg.addColorStop(0,"#08060e");bg.addColorStop(0.4,"#0f0a1e");bg.addColorStop(1,"#1a1025");
  c.fillStyle=bg;c.fillRect(0,0,cw,ch);

  const isActive=gs.phase==="menu"||gs.phase==="playing"||gs.phase==="ending"||gs.phase==="quote";

  if(isActive){
    // Clouds
    gs.cloudOff+=0.08;
    c.save();c.globalAlpha=0.2;c.fillStyle="rgba(30,20,45,1)";
    for(let i=0;i<3;i++){
      const cx2=((gs.cloudOff*(0.2+i*0.15)+i*200)%(cw+300))-150;
      c.beginPath();c.ellipse(cx2,18+i*14,100+i*20,14+i*5,0,0,Math.PI*2);c.fill();
    }
    c.restore();

    // Skyline
    drawSky(cw,ch,now);

    // === RAIN SPAWNING ===
    const canSpawnRain=gs.phase==="playing"||gs.phase==="ending";
    const isMenu=gs.phase==="menu"||gs.phase==="quote";

    if(canSpawnRain&&now-gs.lastRain>RAIN_INT){
      for(let i=0;i<DENSE;i++) gs.drops.push(mkDrop(cw,ch,false));
      gs.lastRain=now;
    }
    if(isMenu&&now-gs.lastRain>100){
      for(let i=0;i<2;i++){const d=mkDrop(cw,ch,false);d.opacity=0.03+Math.random()*0.06;gs.drops.push(d);}
      gs.lastRain=now;
    }

    // Glow drop spawning — only during playing, with scheduled gaps
    if(gs.phase==="playing"&&now>=gs.nextGlow){
      gs.drops.push(mkDrop(cw,ch,true));
      scheduleGlow();
    }

    // Cap
    if(gs.drops.length>500) gs.drops.splice(0,gs.drops.length-500);

    // Update & draw drops
    for(let i=gs.drops.length-1;i>=0;i--){
      const d=gs.drops[i];d.y+=d.speed;d.x+=d.drift;
      if(d.caught){d.fadeOut-=0.08;if(d.fadeOut<=0){gs.drops.splice(i,1);continue;}}
      if(d.y > ch){
  if(d.isGlowing){
    d.fadeOut -= 0.06;
    if(d.fadeOut <= 0){
      gs.drops.splice(i,1);
      continue;
    }
  } else {
    gs.drops.splice(i,1);
    continue;
  }
}

      // During ending, gradually slow and fade regular rain
      if(gs.phase==="ending"&&!d.isGlowing){
        d.opacity*=0.998;
        d.speed*=0.999;
      }

      drawDrop(d);
    }

    // Ground splashes
    if(gs.phase==="playing"){
      for(let i=0;i<2;i++){
        const sx=Math.random()*cw,sy=ch-2+Math.random()*3;
        c.fillStyle=`rgba(150,145,175,${0.04+Math.random()*0.04})`;
        c.beginPath();c.ellipse(sx,sy,2+Math.random()*3,1,0,0,Math.PI*2);c.fill();
      }
    }

    // Ripples
    for(let i=gs.ripples.length-1;i>=0;i--){
      const r=gs.ripples[i];r.radius+=r.speed;r.opacity-=0.01;
      if(r.opacity<=0){gs.ripples.splice(i,1);continue;}
      c.save();c.strokeStyle=`rgba(200,175,255,${r.opacity})`;c.lineWidth=1;
      c.beginPath();c.arc(r.x,r.y,r.radius,0,Math.PI*2);c.stroke();c.restore();
    }

    // Catch particles
    for(let i=gs.catchPs.length-1;i>=0;i--){
      const p=gs.catchPs[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.04;p.life-=0.016;
      if(p.life<=0){gs.catchPs.splice(i,1);continue;}
      c.save();c.globalAlpha=p.life;c.fillStyle=p.color+p.life+")";
      c.beginPath();c.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);c.fill();c.restore();
    }
  }

  // === PLAYING UI ===
  if(gs.phase==="playing"){
    // Vertical progress bar — left side
    const barW=5,barH=ch*0.6,barX=12,barY=(ch-barH)/2;
    const prog=Math.min(gs.score/DROPS_TO_WIN,1);
    c.fillStyle="rgba(255,255,255,0.06)";
    c.beginPath();c.roundRect(barX,barY,barW,barH,3);c.fill();
    if(prog>0){
      const fillH=barH*prog;
      const fg=c.createLinearGradient(0,barY+barH,0,barY+barH-fillH);
      fg.addColorStop(0,"rgba(180,140,240,0.4)");fg.addColorStop(1,"rgba(220,200,255,0.7)");
      c.fillStyle=fg;c.beginPath();c.roundRect(barX,barY+barH-fillH,barW,fillH,3);c.fill();
      c.shadowColor="rgba(180,140,240,0.35)";c.shadowBlur=6;
      c.beginPath();c.roundRect(barX,barY+barH-fillH,barW,fillH,3);c.fill();c.shadowBlur=0;
    }
    // Score text — below bar
    c.fillStyle="rgba(255,255,255,0.65)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText(`${gs.score}`,barX+barW/2,barY+barH+18);
    // Timer — top right
    const m=Math.floor(gs.timeLeft/60),s=gs.timeLeft%60;
    c.fillStyle="rgba(255,255,255,0.5)";c.font="14px 'Helvetica Neue',sans-serif";
    c.textAlign="right";c.fillText(`${m}:${s.toString().padStart(2,"0")}`,cw-15,22);
  }

  // === MENU ===
  if(gs.phase==="menu"){
    gs.menuPulse+=0.018;
    // Darker backdrop for readability
    c.fillStyle="rgba(8,6,14,0.45)";c.fillRect(0,ch*0.28,cw,ch*0.42);
    // Title
    c.fillStyle="rgba(245,235,255,0.9)";c.font="600 32px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("raindrops",cw/2,ch/2-22);
    // Tap prompt — pulsing
    c.fillStyle=`rgba(230,210,255,${0.5+Math.sin(gs.menuPulse)*0.2})`;
    c.font="600 15px 'Helvetica Neue',sans-serif";c.fillText("tap to begin",cw/2,ch/2+10);
    // Subtitle
    c.fillStyle="rgba(220,200,245,0.4)";c.font="12px 'Helvetica Neue',sans-serif";
    c.fillText("catch the glowing drops",cw/2,ch/2+32);
    // Scene name
    c.fillStyle="rgba(220,200,245,0.3)";c.font="11px 'Helvetica Neue',sans-serif";
    c.fillText("city at night",cw/2,ch/2+52);
  }
// === ENDING SEQUENCE — RAINBOW TRANSITION ===
  if(gs.phase==="ending"){
    gs.endT+=0.005;
    const t=Math.min(gs.endT,1);

    // Fade rain audio
     if(!gs.rainFaded&&t>0.2){if(rainG&&actx)rainG.gain.linearRampToValueAtTime(0.05,actx.currentTime+4);gs.rainFaded=true;}

    // Interpolate sky to warm colors
    const r1=Math.floor(8+(254-8)*t),g1=Math.floor(6+(243-6)*t),b1=Math.floor(14+(199-14)*t);
    const r2=Math.floor(26+(221-26)*t),g2=Math.floor(16+(214-16)*t),b2=Math.floor(37+(254-37)*t);
    const tbg=c.createLinearGradient(0,0,0,ch);
    tbg.addColorStop(0,`rgb(${r1},${g1},${b1})`);tbg.addColorStop(1,`rgb(${r2},${g2},${b2})`);
    c.fillStyle=tbg;c.fillRect(0,0,cw,ch);

    // Fade remaining drops
    for(let i=gs.drops.length-1;i>=0;i--){
      const d=gs.drops[i];d.opacity*=0.95;d.speed*=0.98;
      if(d.opacity<0.003){gs.drops.splice(i,1);continue;}
      c.save();c.strokeStyle=`rgba(200,190,220,${d.opacity})`;c.lineWidth=d.width;c.lineCap="round";
      c.beginPath();c.moveTo(d.x,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();c.restore();
      d.y+=d.speed;
    }

    // Spawn rainbow particles after 30%
    if(t>0.3){
      if(!gs.rbPs||gs.rbPs.length===0){
        gs.rbPs=[];
        const cols=["#f9a8d4","#fbbf24","#a78bfa","#34d399","#60a5fa","#fb923c","#f472b6"];
        for(let i=0;i<120;i++)gs.rbPs.push({
          x:Math.random()*cw,y:Math.random()*ch,size:3+Math.random()*7,
          color:cols[Math.floor(Math.random()*cols.length)],
          speed:0.2+Math.random()*0.6,wobble:Math.random()*Math.PI*2,
          wobbleSpd:0.01+Math.random()*0.02,opacity:0,
          target:0.3+Math.random()*0.5,shape:Math.random()>0.5?"c":"d",
        });
      }
      const po=(t-0.3)/0.7;
      gs.rbPs.forEach(p=>{
        p.wobble+=p.wobbleSpd;p.y-=p.speed*0.4;p.x+=Math.sin(p.wobble)*0.4;
        if(p.y<-10)p.y=ch+10;
        c.save();c.globalAlpha=p.target*po*0.6;c.fillStyle=p.color;
        if(p.shape==="c"){c.beginPath();c.arc(p.x,p.y,p.size,0,Math.PI*2);c.fill();}
        else{c.translate(p.x,p.y);c.rotate(Math.PI/4);c.fillRect(-p.size/2,-p.size/2,p.size,p.size);}
        c.restore();
      });
    }

    // "breathe" text
    if(t>0.6){
      c.save();c.globalAlpha=Math.min((t-0.6)/0.3,1)*0.5;
      c.fillStyle="rgba(120,80,150,1)";c.font="600 22px 'Helvetica Neue',sans-serif";
      c.textAlign="center";c.fillText("breathe",cw/2,ch/2-10);c.restore();
    }

    if(gs.endT>1.3)gs.phase="quote";
  }

  // === QUOTE SCREEN — RAINBOW WITH QUOTE ===
  if(gs.phase==="quote"){
    // Warm rainbow background
    const rg=c.createLinearGradient(0,0,0,ch);
    rg.addColorStop(0,"#fef3c7");rg.addColorStop(0.35,"#fde68a");rg.addColorStop(0.65,"#fbcfe8");rg.addColorStop(1,"#ddd6fe");
    c.fillStyle=rg;c.fillRect(0,0,cw,ch);

    // Sun
    const sx=cw*0.75,sy=ch*0.2;
    const sg=c.createRadialGradient(sx,sy,0,sx,sy,90);
    sg.addColorStop(0,"rgba(253,224,71,0.7)");sg.addColorStop(0.3,"rgba(253,224,71,0.25)");sg.addColorStop(1,"rgba(253,224,71,0)");
    c.fillStyle=sg;c.beginPath();c.arc(sx,sy,90,0,Math.PI*2);c.fill();
    c.fillStyle="rgba(255,255,255,0.85)";c.beginPath();c.arc(sx,sy,22,0,Math.PI*2);c.fill();

     // Rainbow arc — corner to corner
    const arcY=ch*1.6,arcR=cw*0.9;
    ["#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#8b5cf6"].forEach((col,i)=>{
      c.save();c.strokeStyle=col;c.globalAlpha=0.3;c.lineWidth=12;
      c.beginPath();c.arc(cw*0.5,arcY,arcR+i*14,Math.PI+0.15,Math.PI*2-0.15);c.stroke();c.restore();
    });

    // Floating particles
    if(gs.rbPs)gs.rbPs.forEach(p=>{
      p.wobble+=p.wobbleSpd;p.y-=p.speed*0.25;p.x+=Math.sin(p.wobble)*0.3;
      if(p.opacity<p.target)p.opacity+=0.008;
      if(p.y<-10){p.y=ch+10;p.x=Math.random()*cw;}
      c.save();c.globalAlpha=p.opacity;c.fillStyle=p.color;
      if(p.shape==="c"){c.beginPath();c.arc(p.x,p.y,p.size,0,Math.PI*2);c.fill();}
      else{c.translate(p.x,p.y);c.rotate(Math.PI/4);c.fillRect(-p.size/2,-p.size/2,p.size,p.size);}
      c.restore();
    });

    // Quote with soft background pill
    c.save();
    const words=gs.endQuote.split(" ");
    let lines=[],line="";
    words.forEach(w=>{const test=line?line+" "+w:w;if(test.length>22){lines.push(line);line=w;}else line=test;});
    if(line)lines.push(line);
    const lh=32,qtH=lines.length*lh+36,qtW=cw*0.85,qtX=(cw-qtW)/2,qtY=ch/2-qtH/2-10;
    // Background pill
    c.fillStyle="rgba(255,255,255,0.4)";
    c.beginPath();c.roundRect(qtX,qtY,qtW,qtH,14);c.fill();
    // Quote text
    c.fillStyle="rgba(70,35,100,0.9)";
    c.font="italic 600 22px 'Helvetica Neue',sans-serif";
    c.textAlign="center";
    lines.forEach((l,i)=>c.fillText(l,cw/2,qtY+28+i*lh));
    c.restore();

    // Tap to continue — button style
    const btnW=140,btnH=34,btnX=(cw-btnW)/2,btnY=ch-55;
    c.fillStyle="rgba(255,255,255,0.3)";
    c.beginPath();c.roundRect(btnX,btnY,btnW,btnH,17);c.fill();
    c.fillStyle="rgba(90,50,130,0.7)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("tap to continue",cw/2,btnY+btnH/2+4);
  }

  requestAnimationFrame(loop);
}

scheduleGlow();
requestAnimationFrame(loop);
</script>
</body>
</html>
