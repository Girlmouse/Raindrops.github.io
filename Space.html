<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Raindrops — A moment in time</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{background:#020412;display:flex;flex-direction:column;align-items:center;justify-content:center;
min-height:100vh;min-height:100dvh;font-family:'Helvetica Neue',-apple-system,sans-serif;
user-select:none;-webkit-user-select:none;touch-action:none;overflow:hidden;}
canvas{border-radius:12px;cursor:pointer;touch-action:none;box-shadow:0 0 60px rgba(80,100,180,0.04);}
.sub{color:rgba(255,255,255,0.25);font-size:12px;margin-top:10px;letter-spacing:2px;text-align:center;}
</style>
</head>
<body>
<canvas id="g"></canvas>
<p class="sub">RAINDROPS — A moment in time</p>
<script>
// === AUDIO ===
let actx=null,started=false;

function initAudio(){
  if(started)return;try{
  actx=new(window.AudioContext||window.webkitAudioContext)();started=true;
  const sr=actx.sampleRate,len=sr*4;

  // Layer 1: Deep space hum — very low drone
  const buf1=actx.createBuffer(2,len,sr);
  for(let ch=0;ch<2;ch++){const d=buf1.getChannelData(ch);let last=0;
    for(let i=0;i<len;i++){const w=Math.random()*2-1;d[i]=(last+(0.01*w))/1.01;last=d[i];d[i]*=2;}}
  const src1=actx.createBufferSource();src1.buffer=buf1;src1.loop=true;
  const f1=actx.createBiquadFilter();f1.type="lowpass";f1.frequency.value=200;
  const g1=actx.createGain();g1.gain.value=0.12;
  src1.connect(f1);f1.connect(g1);g1.connect(actx.destination);src1.start();

  // Layer 2: Soft wind texture — very gentle high presence
  const buf2=actx.createBuffer(2,len,sr);
  for(let ch=0;ch<2;ch++){const d=buf2.getChannelData(ch);
    for(let i=0;i<len;i++){const env=0.3+0.7*Math.sin(i/sr*0.15*Math.PI*2);d[i]=(Math.random()*2-1)*env;}}
  const src2=actx.createBufferSource();src2.buffer=buf2;src2.loop=true;
  const f2=actx.createBiquadFilter();f2.type="bandpass";f2.frequency.value=400;f2.Q.value=3;
  const g2=actx.createGain();g2.gain.value=0.025;
  src2.connect(f2);f2.connect(g2);g2.connect(actx.destination);src2.start();

  // Layer 3: Tonal drone — a single low note for warmth
  const drone=actx.createOscillator();
  drone.type="sine";drone.frequency.value=55; // A1
  const dg=actx.createGain();dg.gain.value=0.04;
  drone.connect(dg);dg.connect(actx.destination);drone.start();
  // Second harmonic
  const drone2=actx.createOscillator();
  drone2.type="sine";drone2.frequency.value=82.4; // E2
  const dg2=actx.createGain();dg2.gain.value=0.02;
  drone2.connect(dg2);dg2.connect(actx.destination);drone2.start();

  }catch(e){}}

// Celestial chime — ethereal, spacey
function chime(x,y,cw,ch){
  if(!actx)return;
  const notes=[523.2,659.2,784,880,1046.5,1318.5,1568];
  const f=notes[Math.floor(Math.random()*notes.length)];
  // Primary tone
  const o=actx.createOscillator(),g=actx.createGain();
  o.type="sine";o.frequency.value=f;
  g.gain.setValueAtTime(0.1,actx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.02,actx.currentTime+1.0);
  g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+2.5);
  o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+2.5);
  // Detuned shimmer
  const o2=actx.createOscillator(),g2=actx.createGain();
  o2.type="sine";o2.frequency.value=f*1.003;
  g2.gain.setValueAtTime(0.05,actx.currentTime);
  g2.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+2.0);
  o2.connect(g2);g2.connect(actx.destination);o2.start();o2.stop(actx.currentTime+2.0);
  // Sub octave
  const o3=actx.createOscillator(),g3=actx.createGain();
  o3.type="sine";o3.frequency.value=f*0.5;
  g3.gain.setValueAtTime(0.03,actx.currentTime);
  g3.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+1.5);
  o3.connect(g3);g3.connect(actx.destination);o3.start();o3.stop(actx.currentTime+1.5);
}

// === CANVAS ===
const cv=document.getElementById("g"),c=cv.getContext("2d");
function getSize(){
  const mw=Math.min(window.innerWidth*0.98,700);
  const mh=(window.innerHeight||document.documentElement.clientHeight)*0.90;
  let w=mw,h=w/(16/9);if(h>mh){h=mh;w=h*(16/9);}if(w>mw){w=mw;h=w/(16/9);}
  return{w:Math.floor(w),h:Math.floor(h)};
}
function resize(){const{w,h}=getSize();cv.width=w*2;cv.height=h*2;cv.style.width=w+"px";cv.style.height=h+"px";c.setTransform(2,0,0,2,0,0);}
resize();window.addEventListener("resize",resize);

// === STARS ===
function buildStars(w,h){
  const stars=[];
  for(let i=0;i<80;i++){
    stars.push({
      x:Math.random()*w,
      y:Math.random()*h*0.75, // above lunar horizon
      size:0.5+Math.random()*1.8,
      baseAlpha:0.15+Math.random()*0.5,
      twinkleSpeed:0.002+Math.random()*0.006,
      twinklePhase:Math.random()*Math.PI*2,
      warm:Math.random()>0.8, // some stars slightly warm-tinted
    });
  }
  return stars;
}
let stars=null;

// === SHOOTING STARS ===
const shooters=[];
const ripples=[];
const SHOOT_MIN=4000,SHOOT_MAX=9000;
let nextShoot=Date.now()+2000;

function scheduleShoot(){
  nextShoot=Date.now()+SHOOT_MIN+Math.random()*(SHOOT_MAX-SHOOT_MIN);
}

function spawnShooter(w,h){
  // Start from upper portion, travel diagonally
  const startX=Math.random()*w*0.8;
  const startY=Math.random()*h*0.4;
  const angle=0.3+Math.random()*0.6; // roughly diagonal downward-right
  const speed=2+Math.random()*2;
  shooters.push({
    x:startX,y:startY,
    vx:Math.cos(angle)*speed,
    vy:Math.sin(angle)*speed,
    life:1,
    length:20+Math.random()*30,
    caught:false,fadeOut:1,
    trail:[],
  });
}

// === LUNAR SURFACE ===
function buildCraters(w,h){
  const craters=[];
  for(let i=0;i<12;i++){
    craters.push({
      x:Math.random()*w,
      y:h*0.78+Math.random()*h*0.2,
      r:5+Math.random()*20,
      depth:0.02+Math.random()*0.03,
    });
  }
  return craters;
}
let craters=null;

function drawMoon(w,h){
  if(!craters)craters=buildCraters(w,h);
  const surfaceY=h*0.78;

  // Curved horizon — subtle arc
  c.save();
  c.fillStyle="rgba(18,18,24,1)";
  c.beginPath();
  c.moveTo(0,h);
  c.lineTo(0,surfaceY+10);
  // Gentle curve across
  c.quadraticCurveTo(w*0.25,surfaceY-5,w*0.5,surfaceY);
  c.quadraticCurveTo(w*0.75,surfaceY+5,w,surfaceY-2);
  c.lineTo(w,h);
  c.closePath();
  c.fill();

  // Surface texture gradient
  const surfGrad=c.createLinearGradient(0,surfaceY-10,0,h);
  surfGrad.addColorStop(0,"rgba(30,30,40,1)");
  surfGrad.addColorStop(0.3,"rgba(22,22,30,1)");
  surfGrad.addColorStop(1,"rgba(14,14,20,1)");
  c.fillStyle=surfGrad;
  c.beginPath();
  c.moveTo(0,h);
  c.lineTo(0,surfaceY+10);
  c.quadraticCurveTo(w*0.25,surfaceY-5,w*0.5,surfaceY);
  c.quadraticCurveTo(w*0.75,surfaceY+5,w,surfaceY-2);
  c.lineTo(w,h);
  c.closePath();
  c.fill();

  // Craters
  craters.forEach(cr=>{
    // Shadow
    c.fillStyle=`rgba(10,10,16,${cr.depth})`;
    c.beginPath();c.ellipse(cr.x,cr.y,cr.r,cr.r*0.3,0,0,Math.PI*2);c.fill();
    // Rim highlight
    c.strokeStyle=`rgba(45,45,58,${cr.depth*1.5})`;
    c.lineWidth=0.5;
    c.beginPath();c.ellipse(cr.x,cr.y,cr.r,cr.r*0.3,0,Math.PI*1.1,Math.PI*1.9);c.stroke();
  });
  c.restore();

  // Horizon glow — very subtle
  const hGlow=c.createLinearGradient(0,surfaceY-20,0,surfaceY+5);
  hGlow.addColorStop(0,"rgba(60,65,90,0)");
  hGlow.addColorStop(0.7,"rgba(60,65,90,0.04)");
  hGlow.addColorStop(1,"rgba(60,65,90,0)");
  c.fillStyle=hGlow;c.fillRect(0,surfaceY-20,w,25);
}

// === EARTH ===
function drawEarth(w,h,t){
  const ex=w*0.22,ey=h*0.3;
  const er=18;

  // Atmospheric halo
  const halo=c.createRadialGradient(ex,ey,er,ex,ey,er*3);
  halo.addColorStop(0,"rgba(100,160,240,0.08)");
  halo.addColorStop(0.4,"rgba(80,140,220,0.04)");
  halo.addColorStop(1,"rgba(80,140,220,0)");
  c.fillStyle=halo;c.beginPath();c.arc(ex,ey,er*3,0,Math.PI*2);c.fill();

  // Earth body
  c.save();
  c.beginPath();c.arc(ex,ey,er,0,Math.PI*2);c.clip();

  // Base blue
  const eg=c.createRadialGradient(ex-3,ey-3,0,ex,ey,er);
  eg.addColorStop(0,"rgba(70,130,210,0.9)");
  eg.addColorStop(0.5,"rgba(50,110,190,0.85)");
  eg.addColorStop(1,"rgba(30,70,140,0.8)");
  c.fillStyle=eg;c.fillRect(ex-er,ey-er,er*2,er*2);

  // Very slow rotation for landmasses
  const rot=t*0.00002;

  // Simplified continents — soft white/green patches
  c.globalAlpha=0.3;
  c.fillStyle="rgba(120,180,130,1)";
  // Patch 1
  c.beginPath();
  c.ellipse(ex-5+Math.sin(rot)*3,ey-4,6,8,0.3+rot,0,Math.PI*2);c.fill();
  // Patch 2
  c.fillStyle="rgba(140,190,140,1)";
  c.beginPath();
  c.ellipse(ex+7+Math.sin(rot)*2,ey+2,4,5,-0.2+rot,0,Math.PI*2);c.fill();
  // Patch 3 (small)
  c.fillStyle="rgba(150,200,150,1)";
  c.beginPath();
  c.ellipse(ex+2+Math.cos(rot)*2,ey+8,3,2,0.5+rot,0,Math.PI*2);c.fill();

  // Cloud wisps
  c.globalAlpha=0.2;
  c.fillStyle="rgba(220,230,250,1)";
  c.beginPath();
  c.ellipse(ex-3+Math.sin(rot*2)*2,ey-6,8,2,0.2+rot*0.5,0,Math.PI*2);c.fill();
  c.beginPath();
  c.ellipse(ex+5+Math.cos(rot*2)*2,ey+5,6,1.5,-0.3+rot*0.5,0,Math.PI*2);c.fill();

  c.restore();

  // Rim light
  c.strokeStyle="rgba(130,180,240,0.15)";
  c.lineWidth=1;
  c.beginPath();c.arc(ex,ey,er,0,Math.PI*2);c.stroke();

  // Bright edge highlight (sun side)
  c.save();
  c.globalAlpha=0.12;
  c.strokeStyle="rgba(200,220,255,1)";
  c.lineWidth=1.5;
  c.beginPath();c.arc(ex,ey,er-0.5,Math.PI*1.2,Math.PI*1.8);c.stroke();
  c.restore();
}

// === STATE ===
let phase="sanctuary"; // always sanctuary, no menu needed... or maybe a gentle entrance

// Button state
const btn={w:130,h:32};

function getBtnPos(cw,ch){
  return{x:(cw-btn.w)/2,y:ch-48};
}

// === INPUT ===
function getPos(e){
  const r=cv.getBoundingClientRect();
  const sx=(cv.width/2)/r.width,sy=(cv.height/2)/r.height;
  const px=e.touches?e.touches[0].clientX:e.clientX;
  const py=e.touches?e.touches[0].clientY:e.clientY;
  return{x:(px-r.left)*sx,y:(py-r.top)*sy};
}

function tap(e){
  e.preventDefault();initAudio();
  const{w:cw,h:ch}=getSize();
  const{x,y}=getPos(e);

  // Check "take me home" button
  const bp=getBtnPos(cw,ch);
  if(x>=bp.x&&x<=bp.x+btn.w&&y>=bp.y&&y<=bp.y+btn.h){
    // Navigate back — or just reload to show they can leave
    window.history.back();
    return;
  }

  // Check shooting star catch
  let caught=false;
  for(let i=0;i<shooters.length;i++){
    const s=shooters[i];
    if(s.caught)continue;
    const dist=Math.hypot(x-s.x,y-s.y);
    if(dist<50){
      s.caught=true;caught=true;
      chime(s.x,s.y,cw,ch);
      // Glow ripple
      ripples.push({x:s.x,y:s.y,radius:5,opacity:0.6,speed:0.8,
        color:"rgba(200,210,255,"});
      ripples.push({x:s.x,y:s.y,radius:3,opacity:0.3,speed:1.2,
        color:"rgba(255,230,200,"});
      break;
    }
  }

  // Tap anywhere else — subtle ripple
  if(!caught){
    ripples.push({x,y,radius:3,opacity:0.2,speed:0.6,
      color:"rgba(150,160,200,"});
  }
}

cv.addEventListener("click",tap);
cv.addEventListener("touchstart",tap,{passive:false});

// === MAIN LOOP ===
let fadeIn=0;

function loop(){
  const now=Date.now(),{w:cw,h:ch}=getSize();

  // Gentle fade in
  if(fadeIn<1)fadeIn+=0.005;

  // === BACKGROUND — deep indigo space ===
  const bg=c.createLinearGradient(0,0,0,ch);
  bg.addColorStop(0,"#020412");
  bg.addColorStop(0.3,"#060a22");
  bg.addColorStop(0.6,"#0a1030");
  bg.addColorStop(0.8,"#0e1438");
  bg.addColorStop(1,"#020412");
  c.fillStyle=bg;c.fillRect(0,0,cw,ch);

  c.save();
  c.globalAlpha=fadeIn;

  // === STARS ===
  if(!stars)stars=buildStars(cw,ch);
  stars.forEach(s=>{
    const twinkle=s.baseAlpha*(0.5+0.5*Math.sin(now*s.twinkleSpeed+s.twinklePhase));
    if(s.warm){
      c.fillStyle=`rgba(255,220,180,${twinkle})`;
    } else {
      c.fillStyle=`rgba(220,225,255,${twinkle})`;
    }
    c.beginPath();c.arc(s.x,s.y,s.size,0,Math.PI*2);c.fill();
  });

  // === EARTH ===
  drawEarth(cw,ch,now);

  // === MOON SURFACE ===
  drawMoon(cw,ch);

  // === SHOOTING STARS ===
  // Spawn
  if(now>=nextShoot){
    spawnShooter(cw,ch);
    scheduleShoot();
  }

  // Update & draw
  for(let i=shooters.length-1;i>=0;i--){
    const s=shooters[i];
    if(s.caught){
      s.fadeOut-=0.03;
      if(s.fadeOut<=0){shooters.splice(i,1);continue;}
      // Expanding glow on catch
      c.save();
      const cg=c.createRadialGradient(s.x,s.y,0,s.x,s.y,30*(1-s.fadeOut));
      cg.addColorStop(0,`rgba(220,210,255,${0.3*s.fadeOut})`);
      cg.addColorStop(1,"rgba(220,210,255,0)");
      c.fillStyle=cg;c.beginPath();c.arc(s.x,s.y,30*(1-s.fadeOut),0,Math.PI*2);c.fill();
      c.restore();
      continue;
    }

    s.x+=s.vx;s.y+=s.vy;
    s.life-=0.005;

    // Trail
    s.trail.push({x:s.x,y:s.y,alpha:0.6});
    if(s.trail.length>20)s.trail.shift();

    if(s.life<=0||s.x>cw+50||s.y>ch*0.75){
      shooters.splice(i,1);continue;
    }

    // Draw trail
    for(let t=0;t<s.trail.length;t++){
      const tp=s.trail[t];
      tp.alpha*=0.88;
      const trailW=1.5*(t/s.trail.length);
      c.strokeStyle=`rgba(220,215,255,${tp.alpha*s.life})`;
      c.lineWidth=trailW;c.lineCap="round";
      if(t>0){
        c.beginPath();
        c.moveTo(s.trail[t-1].x,s.trail[t-1].y);
        c.lineTo(tp.x,tp.y);
        c.stroke();
      }
    }

    // Head glow
    const hg=c.createRadialGradient(s.x,s.y,0,s.x,s.y,10);
    hg.addColorStop(0,`rgba(240,235,255,${0.5*s.life})`);
    hg.addColorStop(0.5,`rgba(200,200,240,${0.15*s.life})`);
    hg.addColorStop(1,"rgba(200,200,240,0)");
    c.fillStyle=hg;c.beginPath();c.arc(s.x,s.y,10,0,Math.PI*2);c.fill();

    // Bright core
    c.fillStyle=`rgba(255,255,255,${0.8*s.life})`;
    c.beginPath();c.arc(s.x,s.y,1.5,0,Math.PI*2);c.fill();
  }

  // === RIPPLES ===
  for(let i=ripples.length-1;i>=0;i--){
    const r=ripples[i];
    r.radius+=r.speed;r.opacity-=0.008;
    if(r.opacity<=0){ripples.splice(i,1);continue;}
    c.save();c.strokeStyle=r.color+r.opacity+")";c.lineWidth=1;
    c.beginPath();c.arc(r.x,r.y,r.radius,0,Math.PI*2);c.stroke();c.restore();
  }

  // === "TAKE ME HOME" BUTTON ===
  const bp=getBtnPos(cw,ch);
  c.fillStyle="rgba(255,255,255,0.06)";
  c.beginPath();c.roundRect(bp.x,bp.y,btn.w,btn.h,16);c.fill();
  c.strokeStyle="rgba(200,210,240,0.12)";c.lineWidth=0.5;
  c.beginPath();c.roundRect(bp.x,bp.y,btn.w,btn.h,16);c.stroke();
  c.fillStyle="rgba(200,210,240,0.45)";
  c.font="600 12px 'Helvetica Neue',sans-serif";
  c.textAlign="center";
  c.fillText("take me home",bp.x+btn.w/2,bp.y+btn.h/2+4);

  c.restore();

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>
