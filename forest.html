<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Raindrops — A moment in time</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{background:#0a1a0e;display:flex;flex-direction:column;align-items:center;justify-content:center;
min-height:100vh;min-height:100dvh;font-family:'Helvetica Neue',-apple-system,sans-serif;
user-select:none;-webkit-user-select:none;touch-action:none;overflow:hidden;}
canvas{border-radius:12px;cursor:pointer;touch-action:none;box-shadow:0 0 60px rgba(80,180,100,0.06);}
.sub{color:rgba(255,255,255,0.25);font-size:12px;margin-top:10px;letter-spacing:2px;text-align:center;}
</style>
</head>
<body>
<canvas id="g"></canvas>
<audio id="rainAudio" preload="auto" loop playsinline>
  <source src="audio/rain.mp3" type="audio/mpeg">
</audio>
<audio id="cricketsAudio" preload="auto" loop playsinline>
  <source src="audio/crickets.mp3" type="audio/mpeg">
</audio>
<p class="sub">RAINDROPS — A moment in time</p>
<script>
// === CONFIG ===
const DROPS_TO_WIN = 20;
const RAIN_INT = 40;
const GLOW_MIN_GAP = 3000;
const GLOW_MAX_GAP = 6000;
const HIT_R = 45;
const DENSE = 6;
const GLOW_MARGIN = 0.12;

const QUOTES = [
  "breathe",
  "feel",
  "listen",
  "notice",
  "pause",
  "reflect",
  "release",
  "May your worries be as short lived as a fart on a windy day. — BH",
];
let quoteIndex = 0;
const IS_MOBILE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

// === AUDIO ===
let actx=null, started=false;
let rainBuffer=null, cricketsBuffer=null;
let rainGain=null, cricketsGain=null;
let rainPlaying=false;

const CROSSFADE_DUR = 4.0;
let rainXfSrc=null, rainXfTimer=null;
let crickXfSrc=null, crickXfTimer=null;

function loadBuffer(url, onDone){
  fetch(url)
    .then(r=>{ if(!r.ok) throw new Error("fetch failed"); return r.arrayBuffer(); })
    .then(ab=>actx.decodeAudioData(ab))
    .then(buf=>onDone(buf))
    .catch(e=>{ console.log("Crossfade unavailable for "+url+", using fallback:", e); useFallback(); });
}

function useFallback(){
  const rainEl=document.getElementById("rainAudio");
  const crickEl=document.getElementById("cricketsAudio");
  if(rainEl){ rainEl.volume=IS_MOBILE?1.0:0.7; rainEl.muted=false; if(rainPlaying) rainEl.play().catch(()=>{}); }
  if(crickEl){ crickEl.volume=IS_MOBILE?0.4:0.3; crickEl.muted=false; if(rainPlaying) crickEl.play().catch(()=>{}); }
}

function scheduleXf(buffer, gainNode, state){
  if(!actx||!buffer||!gainNode) return;
  const dur=buffer.duration;
  const src=actx.createBufferSource();
  src.buffer=buffer;
  const srcG=actx.createGain();
  srcG.gain.setValueAtTime(0, state.startAt);
  srcG.gain.linearRampToValueAtTime(1, state.startAt+CROSSFADE_DUR);
  const fadeOutAt=state.startAt+dur-CROSSFADE_DUR;
  srcG.gain.setValueAtTime(1, fadeOutAt);
  srcG.gain.linearRampToValueAtTime(0, state.startAt+dur);
  src.connect(srcG); srcG.connect(gainNode);
  src.start(state.startAt); src.stop(state.startAt+dur);
  state.src=src;
  const delay=Math.max(0,(state.startAt+dur-CROSSFADE_DUR-actx.currentTime)*1000);
  state.timer=setTimeout(()=>{ state.startAt=actx.currentTime; scheduleXf(buffer,gainNode,state); }, delay);
}

const rainState={src:null,timer:null,startAt:0};
const crickState={src:null,timer:null,startAt:0};

function startLoops(){
  if(!actx) return;
  if(rainBuffer && rainGain){ rainState.startAt=actx.currentTime; scheduleXf(rainBuffer,rainGain,rainState); }
  if(cricketsBuffer && cricketsGain){ crickState.startAt=actx.currentTime; scheduleXf(cricketsBuffer,cricketsGain,crickState); }
}

function stopLoops(){
  [rainState,crickState].forEach(st=>{
    if(st.timer){ clearTimeout(st.timer); st.timer=null; }
    if(st.src){ try{ st.src.stop(); }catch(e){} st.src=null; }
  });
}

function initAudio(){
  if(started) return;
  try{
    actx=new(window.AudioContext||window.webkitAudioContext)();
    // Rain gain
    rainGain=actx.createGain(); rainGain.gain.value=IS_MOBILE?1.0:0.7; rainGain.connect(actx.destination);
    // Crickets gain — quieter
    cricketsGain=actx.createGain(); cricketsGain.gain.value=IS_MOBILE?0.6:0.45; cricketsGain.connect(actx.destination);
    started=true;
    loadBuffer("audio/rain.mp3", buf=>{ rainBuffer=buf; if(rainPlaying) startLoops(); });
    loadBuffer("audio/crickets.mp3", buf=>{ cricketsBuffer=buf; if(rainPlaying && crickState.src===null) { crickState.startAt=actx.currentTime; scheduleXf(cricketsBuffer,cricketsGain,crickState); } });
  }catch(e){}
}

// Harp-like pluck sound
function chime(){
  if(!actx)return;
  const notes=[392,440,523.2,587.3,659.2,784,880]; // G4-A5 pentatonic-ish
  const f=notes[Math.floor(Math.random()*notes.length)];
  // Plucked string: triangle wave with fast attack, medium decay
  const o=actx.createOscillator(),g=actx.createGain();
  o.type="triangle";o.frequency.value=f;
  g.gain.setValueAtTime(0.18,actx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01,actx.currentTime+0.5);
  g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+1.0);
  o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+1.0);
  // Harmonic overtone for richness
  const o2=actx.createOscillator(),g2=actx.createGain();
  o2.type="sine";o2.frequency.value=f*2;
  g2.gain.setValueAtTime(0.06,actx.currentTime);
  g2.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.4);
  o2.connect(g2);g2.connect(actx.destination);o2.start();o2.stop(actx.currentTime+0.4);
}

function playEnd(){
  if(!actx) return;
  // Fade rain and crickets
  if(rainGain){ rainGain.gain.cancelScheduledValues(actx.currentTime); rainGain.gain.linearRampToValueAtTime(0.08,actx.currentTime+4); }
  if(cricketsGain){ cricketsGain.gain.cancelScheduledValues(actx.currentTime); cricketsGain.gain.linearRampToValueAtTime(0.04,actx.currentTime+4); }
  [261.6,329.6,392,523.2].forEach((f,i)=>{
    const o=actx.createOscillator(),g=actx.createGain();
    o.type="triangle";o.frequency.value=f;
    g.gain.setValueAtTime(0,actx.currentTime+i*0.3);
    g.gain.linearRampToValueAtTime(0.05,actx.currentTime+i*0.3+0.6);
    g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+i*0.3+4);
    o.connect(g);g.connect(actx.destination);o.start(actx.currentTime+i*0.3);o.stop(actx.currentTime+i*0.3+4);
  });
}

function resetRain(){
  if(rainGain && actx){
    rainGain.gain.cancelScheduledValues(actx.currentTime);
    rainGain.gain.linearRampToValueAtTime(IS_MOBILE?1.0:0.7, actx.currentTime+1);
    cricketsGain.gain.cancelScheduledValues(actx.currentTime);
    cricketsGain.gain.linearRampToValueAtTime(IS_MOBILE?0.6:0.45, actx.currentTime+1);
    stopLoops(); rainPlaying=true; startLoops();
  } else {
    useFallback();
  }
}

// === CANVAS ===
const cv=document.getElementById("g"),c=cv.getContext("2d");
function getSize(){
  const mw=Math.min(window.innerWidth*0.98,700);
  const mh=(window.innerHeight||document.documentElement.clientHeight)*0.90;
  let w=mw,h=w/(16/9);if(h>mh){h=mh;w=h*(16/9);}if(w>mw){w=mw;h=w/(16/9);}
  return{w:Math.floor(w),h:Math.floor(h)};
}
function resize(){const{w,h}=getSize();cv.width=w*2;cv.height=h*2;cv.style.width=w+"px";cv.style.height=h+"px";c.setTransform(2,0,0,2,0,0);}
resize();window.addEventListener("resize",resize);

// === FOREST TREES ===
function buildForest(w,h){
  const trees=[];
  // Background layer (smaller, darker)
  for(let i=0;i<18;i++){
    trees.push({
      x:-20+Math.random()*(w+40),
      h:h*0.25+Math.random()*h*0.2,
      w:20+Math.random()*15,
      layer:0,
      shade:Math.random()*0.15,
    });
  }
  // Midground layer
  for(let i=0;i<12;i++){
    trees.push({
      x:-20+Math.random()*(w+40),
      h:h*0.35+Math.random()*h*0.25,
      w:25+Math.random()*20,
      layer:1,
      shade:Math.random()*0.1,
    });
  }
  // Foreground layer (tall silhouettes)
  for(let i=0;i<8;i++){
    trees.push({
      x:-10+Math.random()*(w+20),
      h:h*0.5+Math.random()*h*0.3,
      w:30+Math.random()*25,
      layer:2,
      shade:Math.random()*0.05,
    });
  }
  trees.sort((a,b)=>a.layer-b.layer);
  return trees;
}
let forest=null;

function drawForest(w,h,t){
  if(!forest)forest=buildForest(w,h);
  const baseY=h;

  // Ground fog
  const fog=c.createLinearGradient(0,h*0.7,0,h);
  fog.addColorStop(0,"rgba(15,30,18,0)");
  fog.addColorStop(1,"rgba(15,30,18,0.3)");
  c.fillStyle=fog;c.fillRect(0,h*0.7,w,h*0.3);

  forest.forEach(tr=>{
    const darkness=[0.92,0.88,0.95][tr.layer];
    const green=[12,16,8][tr.layer];
    const alpha=darkness-tr.shade;

    // Trunk
    const trunkW=tr.w*0.08+2;
    c.fillStyle=`rgba(${green-4},${green},${green-6},${alpha})`;
    c.fillRect(tr.x-trunkW/2,baseY-tr.h*0.4,trunkW,tr.h*0.4);

    // Canopy — layered ellipses for organic look
    c.fillStyle=`rgba(${green},${green+8},${green-2},${alpha})`;
    // Main canopy
    c.beginPath();
    c.ellipse(tr.x,baseY-tr.h*0.55,tr.w*0.5,tr.h*0.35,0,0,Math.PI*2);
    c.fill();
    // Top tuft
    c.beginPath();
    c.ellipse(tr.x-tr.w*0.1,baseY-tr.h*0.75,tr.w*0.3,tr.h*0.2,0,0,Math.PI*2);
    c.fill();
    // Side tuft
    c.beginPath();
    c.ellipse(tr.x+tr.w*0.2,baseY-tr.h*0.5,tr.w*0.25,tr.h*0.18,0,0,Math.PI*2);
    c.fill();

    // Occasional subtle sway (very gentle)
    // Fireflies near trees at certain layers
    if(tr.layer===1&&Math.sin(t*0.001+tr.x*0.1)>0.85){
      const fx=tr.x+Math.sin(t*0.002+tr.x)*15;
      const fy=baseY-tr.h*0.4+Math.cos(t*0.0015+tr.x)*10;
      c.fillStyle="rgba(200,230,100,0.3)";
      c.beginPath();c.arc(fx,fy,2,0,Math.PI*2);c.fill();
      const fg=c.createRadialGradient(fx,fy,0,fx,fy,8);
      fg.addColorStop(0,"rgba(200,230,100,0.12)");fg.addColorStop(1,"rgba(200,230,100,0)");
      c.fillStyle=fg;c.beginPath();c.arc(fx,fy,8,0,Math.PI*2);c.fill();
    }
  });

  // Ground line
  c.fillStyle="rgba(10,20,12,0.8)";
  c.fillRect(0,baseY-3,w,5);

  // Bushes along the ground
  const bushColors=["rgba(8,22,10,0.9)","rgba(12,28,14,0.85)","rgba(6,18,8,0.9)"];
  const bushes=[
    {x:w*0.05,r:18},{x:w*0.15,r:14},{x:w*0.28,r:20},
    {x:w*0.42,r:12},{x:w*0.55,r:16},{x:w*0.65,r:22},
    {x:w*0.78,r:13},{x:w*0.88,r:17},{x:w*0.95,r:15},
  ];
  bushes.forEach((b,i)=>{
    c.fillStyle=bushColors[i%bushColors.length];
    c.beginPath();c.ellipse(b.x,baseY-2,b.r,b.r*0.6,0,0,Math.PI*2);c.fill();
    c.beginPath();c.ellipse(b.x-b.r*0.5,baseY-1,b.r*0.6,b.r*0.4,0,0,Math.PI*2);c.fill();
    c.beginPath();c.ellipse(b.x+b.r*0.6,baseY,b.r*0.5,b.r*0.35,0,0,Math.PI*2);c.fill();
  });
}

// === GAME STATE ===
const gs={
  drops:[],catchPs:[],ripples:[],
  score:0,phase:"menu",
  lastRain:0,nextGlow:0,
  cloudOff:0,menuPulse:0,
  endT:0,endQuote:"",
  dimAlpha:0,rainFaded:false,rbPs:null,
  quoteStartTime:0,
};

function scheduleGlow(){
  gs.nextGlow=Date.now()+GLOW_MIN_GAP+Math.random()*(GLOW_MAX_GAP-GLOW_MIN_GAP);
}

function mkDrop(w,h,forceGlow){
  const gl=forceGlow||false;
  // Scale speed relative to canvas height so it looks consistent on all screen sizes
  const speedScale = h / 600;
  const xPos = gl
    ? w*GLOW_MARGIN + Math.random()*w*(1-2*GLOW_MARGIN)
    : Math.random()*w;
  return{
    x:xPos, y:-10-Math.random()*50,
    speed:gl ? (1.0+Math.random()*0.5)*speedScale : (18.0+Math.random()*14.0)*speedScale,
    length:gl?16+Math.random()*10:2+Math.random()*5,
    opacity:gl?1:0.08+Math.random()*0.22,
    isGlowing:gl,pulsePhase:Math.random()*Math.PI*2,
    width:gl?2.5:0.6+Math.random()*0.8,
    caught:false,fadeOut:1,
    drift:(Math.random()-0.5)*0.15,
  };
}

function mkFx(x,y){
  const ps=[];
  for(let i=0;i<14;i++){
    const a=(Math.PI*2*i)/14+Math.random()*0.3,s=2+Math.random()*3;
    ps.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,life:1,size:1.5+Math.random()*3,
      color:Math.random()>0.5?"rgba(160,230,170,":"rgba(120,200,140,"});
  }
  return ps;
}

function mkRip(x,y){return{x,y,radius:3,opacity:0.45,speed:1};}

// === INPUT ===
function getPos(e){
  const r=cv.getBoundingClientRect();
  const sx=(cv.width/2)/r.width,sy=(cv.height/2)/r.height;
  const px=e.touches?e.touches[0].clientX:e.clientX;
  const py=e.touches?e.touches[0].clientY:e.clientY;
  return{x:(px-r.left)*sx,y:(py-r.top)*sy};
}

function tap(e){
  e.preventDefault(); initAudio();

  // Start audio on first tap
  if(!rainPlaying){
    rainPlaying=true;
    if(rainBuffer||cricketsBuffer){ startLoops(); }
    else{ useFallback(); }
  }

  if(gs.phase==="menu"){
    gs.phase="playing";gs.score=0;
    gs.drops=[];gs.catchPs=[];gs.ripples=[];
    gs.endT=0;gs.dimAlpha=0;gs.rainFaded=false;gs.rbPs=null;
    forest=null;scheduleGlow();
    resetRain();lastTick=Date.now();return;
  }

  if(gs.phase==="quote"){
    const rect=cv.getBoundingClientRect();
    const cw=rect.width,ch=rect.height;
    const btnW=120,btnH=34,btnY=ch-55,gap=16;
    const totalW=btnW*2+gap;
    const btn1X=(cw-totalW)/2;
    const btn2X=btn1X+btnW+gap;
    const{x,y}=getPos(e);

    // Home
    if(x>=btn2X&&x<=btn2X+btnW&&y>=btnY&&y<=btnY+btnH){
      stopLoops(); window.location.href="index.html"; return;
    }
    // Replay
    if(x>=btn1X&&x<=btn1X+btnW&&y>=btnY&&y<=btnY+btnH){
      stopLoops(); rainPlaying=false;
      gs.phase="playing";gs.score=0;forest=null;
      gs.drops=[];gs.catchPs=[];gs.ripples=[];
      gs.endT=0;gs.dimAlpha=0;gs.rainFaded=false;gs.rbPs=null;
      scheduleGlow();lastTick=Date.now();
      resetRain();return;
    }
    return;
  }

  if(gs.phase!=="playing")return;

  const{x,y}=getPos(e);
  let best=Infinity,bi=-1;
  for(let i=0;i<gs.drops.length;i++){
    const d=gs.drops[i];if(!d.isGlowing||d.caught)continue;
    const dist=Math.hypot(x-d.x,y-d.y);
    if(dist<HIT_R&&dist<best){best=dist;bi=i;}
  }
  if(bi>=0){
    const d=gs.drops[bi];d.caught=true;gs.score++;
    gs.catchPs.push(...mkFx(d.x,d.y));
    gs.ripples.push(mkRip(d.x,d.y));chime();
    if(gs.score>=DROPS_TO_WIN){
      gs.phase="ending";gs.endT=0;
      gs.endQuote=QUOTES[quoteIndex % QUOTES.length];
      quoteIndex++;
      playEnd();
    }
  } else {
    gs.ripples.push(mkRip(x,y));
  }
}

cv.addEventListener("click",tap);
cv.addEventListener("touchstart",tap,{passive:false});

// === DRAW DROP ===
function drawDrop(d){
  c.save();
  if(d.isGlowing&&!d.caught){
    d.pulsePhase+=0.04;const p=0.6+Math.sin(d.pulsePhase)*0.4;
    // Outer green glow
    const og=c.createRadialGradient(d.x,d.y,0,d.x,d.y,26);
    og.addColorStop(0,`rgba(80,220,120,${0.35*p})`);
    og.addColorStop(0.35,`rgba(60,200,100,${0.18*p})`);
    og.addColorStop(0.65,`rgba(40,180,80,${0.08*p})`);
    og.addColorStop(1,"rgba(30,160,70,0)");
    c.fillStyle=og;c.beginPath();c.ellipse(d.x,d.y,22,28,0,0,Math.PI*2);c.fill();
    // Inner glow
    const ig=c.createRadialGradient(d.x,d.y,0,d.x,d.y,10);
    ig.addColorStop(0,`rgba(180,250,200,${0.6*p})`);
    ig.addColorStop(1,`rgba(120,230,150,${0.25*p})`);
    c.fillStyle=ig;c.beginPath();c.ellipse(d.x,d.y,7,10,0,0,Math.PI*2);c.fill();
    // Core oval
    c.fillStyle=`rgba(220,255,230,${0.85*p*d.fadeOut})`;
    c.beginPath();c.ellipse(d.x,d.y,4,6,0,0,Math.PI*2);c.fill();
    // Bright center
    c.fillStyle=`rgba(255,255,255,${0.95*p*d.fadeOut})`;
    c.beginPath();c.ellipse(d.x,d.y,2,3.5,0,0,Math.PI*2);c.fill();
  } else {
    c.strokeStyle=`rgba(150,190,160,${d.opacity*d.fadeOut})`;c.lineWidth=d.width;c.lineCap="round";
    c.beginPath();c.moveTo(d.x+d.drift*5,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();
  }
  c.restore();
}

// === MAIN LOOP ===
let lastTick=Date.now();

function loop(){
  const now=Date.now(),{w:cw,h:ch}=getSize();

  // No timer — glowing drops only
  if(gs.phase==="playing") lastTick=now;

  // === BG ===
  const bg=c.createLinearGradient(0,0,0,ch);
  bg.addColorStop(0,"#0a1a0e");bg.addColorStop(0.3,"#122010");bg.addColorStop(1,"#1a3020");
  c.fillStyle=bg;c.fillRect(0,0,cw,ch);

  const isActive=gs.phase==="menu"||gs.phase==="playing"||gs.phase==="ending"||gs.phase==="quote";

  if(isActive){
    // Mist / cloud layer
    gs.cloudOff+=0.05;
    c.save();c.globalAlpha=0.15;c.fillStyle="rgba(20,35,22,1)";
    for(let i=0;i<3;i++){
      const cx2=((gs.cloudOff*(0.15+i*0.1)+i*180)%(cw+300))-150;
      c.beginPath();c.ellipse(cx2,15+i*12,110+i*25,12+i*4,0,0,Math.PI*2);c.fill();
    }
    c.restore();

    // Crescent moon
    const moonX=cw*0.78,moonY=ch*0.10,moonR=9;
    // Moon glow
    const mg=c.createRadialGradient(moonX,moonY,moonR*0.5,moonX,moonY,moonR*3);
    mg.addColorStop(0,"rgba(220,230,200,0.15)");mg.addColorStop(1,"rgba(220,230,200,0)");
    c.fillStyle=mg;c.beginPath();c.arc(moonX,moonY,moonR*3,0,Math.PI*2);c.fill();
    // Full circle
    c.fillStyle="rgba(235,240,220,0.95)";
    c.beginPath();c.arc(moonX,moonY,moonR,0,Math.PI*2);c.fill();
    // Shadow circle (creates crescent)
    c.fillStyle="#0a1a0e";
    c.beginPath();c.arc(moonX+5,moonY-1,moonR-1,0,Math.PI*2);c.fill();

    // Forest
    drawForest(cw,ch,now);

    // === RAIN ===
    const canSpawn=gs.phase==="playing"||gs.phase==="ending";
    const isMenu=gs.phase==="menu"||gs.phase==="quote";

    if(canSpawn&&now-gs.lastRain>RAIN_INT){
      for(let i=0;i<DENSE;i++) gs.drops.push(mkDrop(cw,ch,false));
      gs.lastRain=now;
    }
    if(isMenu&&now-gs.lastRain>120){
      for(let i=0;i<2;i++){const d=mkDrop(cw,ch,false);d.opacity=0.04+Math.random()*0.08;gs.drops.push(d);}
      gs.lastRain=now;
    }

    // Glow spawning
    if(gs.phase==="playing"&&now>=gs.nextGlow){
      gs.drops.push(mkDrop(cw,ch,true));
      scheduleGlow();
    }

    if(gs.drops.length>500) gs.drops.splice(0,gs.drops.length-500);

    for(let i=gs.drops.length-1;i>=0;i--){
      const d=gs.drops[i];d.y+=d.speed;d.x+=d.drift;
      if(d.caught){d.fadeOut-=0.08;if(d.fadeOut<=0){gs.drops.splice(i,1);continue;}}
      if(d.y>ch+20){gs.drops.splice(i,1);continue;}
      if((gs.phase==="ending"||gs.phase==="quote")&&d.isGlowing&&!d.caught){
        d.fadeOut-=0.02;if(d.fadeOut<=0){gs.drops.splice(i,1);continue;}
      }
      if(gs.phase==="ending"&&!d.isGlowing){d.opacity*=0.998;d.speed*=0.999;}
      drawDrop(d);
    }

    // Ripples
    for(let i=gs.ripples.length-1;i>=0;i--){
      const r=gs.ripples[i];r.radius+=r.speed;r.opacity-=0.01;
      if(r.opacity<=0){gs.ripples.splice(i,1);continue;}
      c.save();c.strokeStyle=`rgba(130,200,140,${r.opacity})`;c.lineWidth=1;
      c.beginPath();c.arc(r.x,r.y,r.radius,0,Math.PI*2);c.stroke();c.restore();
    }

    // Catch particles
    for(let i=gs.catchPs.length-1;i>=0;i--){
      const p=gs.catchPs[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.04;p.life-=0.016;
      if(p.life<=0){gs.catchPs.splice(i,1);continue;}
      c.save();c.globalAlpha=p.life;c.fillStyle=p.color+p.life+")";
      c.beginPath();c.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);c.fill();c.restore();
    }
  }

  // === PLAYING UI ===
  if(gs.phase==="playing"){
    const barW=5,barH=ch*0.6,barX=12,barY=(ch-barH)/2;
    const prog=Math.min(gs.score/DROPS_TO_WIN,1);
    c.fillStyle="rgba(255,255,255,0.06)";
    c.beginPath();c.roundRect(barX,barY,barW,barH,3);c.fill();
    if(prog>0){
      const fillH=barH*prog;
      const fg=c.createLinearGradient(0,barY+barH,0,barY+barH-fillH);
      fg.addColorStop(0,"rgba(100,200,120,0.4)");fg.addColorStop(1,"rgba(160,240,170,0.7)");
      c.fillStyle=fg;c.beginPath();c.roundRect(barX,barY+barH-fillH,barW,fillH,3);c.fill();
      c.shadowColor="rgba(100,200,120,0.35)";c.shadowBlur=6;
      c.beginPath();c.roundRect(barX,barY+barH-fillH,barW,fillH,3);c.fill();c.shadowBlur=0;
    }
    c.fillStyle="rgba(255,255,255,0.65)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText(`${gs.score}`,barX+barW/2,barY+barH+18);
  }

  // === MENU ===
  if(gs.phase==="menu"){
    gs.menuPulse+=0.018;
    const btnW=140,btnH=34,btnX=(cw-btnW)/2,btnY=ch-55;
    c.fillStyle="rgba(20,55,25,0.85)";
    c.beginPath();c.roundRect(btnX,btnY,btnW,btnH,17);c.fill();
    c.fillStyle=`rgba(160,240,170,${0.8+Math.sin(gs.menuPulse)*0.2})`;
    c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("tap to begin",cw/2,btnY+btnH/2+4);
  }

  // === ENDING SEQUENCE — DARK GREEN TRANSITION ===
  if(gs.phase==="ending"){
    gs.endT+=0.005;
    const t=Math.min(gs.endT,1);

    if(!gs.rainFaded&&t>0.2){ playEnd(); gs.rainFaded=true; }

    // Fade to dark green
    const r1=Math.floor(10+(18-10)*t),g1=Math.floor(20+(38-20)*t),b1=Math.floor(12+(22-12)*t);
    const r2=Math.floor(8+(14-8)*t),g2=Math.floor(26+(45-26)*t),b2=Math.floor(10+(20-10)*t);
    const tbg=c.createLinearGradient(0,0,0,ch);
    tbg.addColorStop(0,`rgb(${r1},${g1},${b1})`);tbg.addColorStop(1,`rgb(${r2},${g2},${b2})`);
    c.fillStyle=tbg;c.fillRect(0,0,cw,ch);

    for(let i=gs.drops.length-1;i>=0;i--){
      const d=gs.drops[i];d.opacity*=0.88;d.speed*=0.96;
      if(d.opacity<0.003){gs.drops.splice(i,1);continue;}
      c.save();c.strokeStyle=`rgba(150,190,155,${d.opacity})`;c.lineWidth=d.width;c.lineCap="round";
      c.beginPath();c.moveTo(d.x,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();c.restore();
      d.y+=d.speed;
    }

    if(t>0.3){
      if(!gs.rbPs||gs.rbPs.length===0){
        gs.rbPs=[];
        const cols=["#22c55e","#4ade80","#86efac","#a3e635","#84cc16","#bef264","#fef08a","#fde047"];
        for(let i=0;i<100;i++) gs.rbPs.push({
          x:Math.random()*cw,y:Math.random()*ch,size:2+Math.random()*5,
          color:cols[Math.floor(Math.random()*cols.length)],
          speed:0.15+Math.random()*0.4,wobble:Math.random()*Math.PI*2,
          wobbleSpd:0.008+Math.random()*0.015,opacity:0,
          target:0.4+Math.random()*0.4,shape:Math.random()>0.5?"c":"d",
        });
      }
      const po=(t-0.3)/0.7;
      gs.rbPs.forEach(p=>{
        p.wobble+=p.wobbleSpd;p.y-=p.speed*0.3;p.x+=Math.sin(p.wobble)*0.3;
        if(p.y<-10)p.y=ch+10;
        c.save();c.globalAlpha=p.target*po*0.5;c.fillStyle=p.color;
        if(p.shape==="c"){c.beginPath();c.arc(p.x,p.y,p.size,0,Math.PI*2);c.fill();}
        else{c.translate(p.x,p.y);c.rotate(Math.PI/4);c.fillRect(-p.size/2,-p.size/2,p.size,p.size);}
        c.restore();
      });
    }

    if(gs.endT>1.3){gs.phase="quote";gs.quoteStartTime=Date.now();}
  }

  // === QUOTE SCREEN — DARK GREEN ===
  if(gs.phase==="quote"){
    const rg=c.createLinearGradient(0,0,0,ch);
    rg.addColorStop(0,"#0d1f10");rg.addColorStop(0.5,"#0a1a0c");rg.addColorStop(1,"#08140a");
    c.fillStyle=rg;c.fillRect(0,0,cw,ch);

    // Floating particles
    if(gs.rbPs) gs.rbPs.forEach(p=>{
      p.wobble+=p.wobbleSpd;p.y-=p.speed*0.2;p.x+=Math.sin(p.wobble)*0.25;
      if(p.opacity<p.target)p.opacity+=0.006;
      if(p.y<-10){p.y=ch+10;p.x=Math.random()*cw;}
      c.save();c.globalAlpha=p.opacity*0.7;c.fillStyle=p.color;
      if(p.shape==="c"){c.beginPath();c.arc(p.x,p.y,p.size,0,Math.PI*2);c.fill();}
      else{c.translate(p.x,p.y);c.rotate(Math.PI/4);c.fillRect(-p.size/2,-p.size/2,p.size,p.size);}
      c.restore();
    });

    // Quote — sized to text
    const quoteAge=(Date.now()-gs.quoteStartTime)/1000;
    const quoteFade=quoteAge<8?1:Math.max(0,1-(quoteAge-8)/2);

    if(quoteFade>0 && gs.endQuote){
      c.save();
      c.font="italic 600 22px 'Helvetica Neue',sans-serif";
      const maxW=cw*0.72;
      const words=gs.endQuote.split(" ");
      let lines=[],cur="";
      for(const w of words){
        const test=cur?cur+" "+w:w;
        if(c.measureText(test).width>maxW&&cur){lines.push(cur);cur=w;}
        else cur=test;
      }
      if(cur)lines.push(cur);
      const lh=34,padX=28,padY=18;
      let maxLineW=0;
      lines.forEach(l=>{const w=c.measureText(l).width;if(w>maxLineW)maxLineW=w;});
      const pillW=maxLineW+padX*2;
      const pillH=lines.length*lh+padY*2;
      const pillX=(cw-pillW)/2;
      const pillY=ch*0.25;

      c.globalAlpha=quoteFade*0.88;
      c.fillStyle="rgba(12,30,15,0.75)";
      c.beginPath();c.roundRect(pillX,pillY,pillW,pillH,14);c.fill();
      c.globalAlpha=quoteFade*0.5;
      c.strokeStyle="rgba(100,200,120,0.3)";c.lineWidth=1;c.stroke();
      c.globalAlpha=quoteFade;
      c.fillStyle="rgba(210,245,215,0.95)";
      c.textAlign="center";c.textBaseline="middle";
      lines.forEach((l,i)=>c.fillText(l,cw/2,pillY+padY+lh*0.5+i*lh));
      c.restore();
    }

    // Replay + Home buttons — forest green scheme
    const btnW=120,btnH=34,btnY=ch-55,gap=16;
    const totalW=btnW*2+gap;
    const btn1X=(cw-totalW)/2;
    const btn2X=btn1X+btnW+gap;

    c.fillStyle="rgba(20,55,25,0.85)";
    c.beginPath();c.roundRect(btn1X,btnY,btnW,btnH,17);c.fill();
    c.fillStyle="rgba(160,240,170,0.95)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("replay",btn1X+btnW/2,btnY+btnH/2+4);

    c.fillStyle="rgba(20,55,25,0.85)";
    c.beginPath();c.roundRect(btn2X,btnY,btnW,btnH,17);c.fill();
    c.fillStyle="rgba(160,240,170,0.95)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("home",btn2X+btnW/2,btnY+btnH/2+4);
  }

  requestAnimationFrame(loop);
}

scheduleGlow();
requestAnimationFrame(loop);
</script>
</body>
</html>
