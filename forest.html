<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Raindrops — A moment in time</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{background:#030a04;display:flex;flex-direction:column;align-items:center;justify-content:center;
min-height:100vh;min-height:100dvh;font-family:'Helvetica Neue',-apple-system,sans-serif;
user-select:none;-webkit-user-select:none;touch-action:none;overflow:hidden;}
canvas{border-radius:12px;cursor:pointer;touch-action:none;box-shadow:0 0 60px rgba(80,180,100,0.06);}
.sub{color:rgba(255,255,255,0.25);font-size:12px;margin-top:10px;letter-spacing:2px;text-align:center;}
</style>
</head>
<body>
<canvas id="g"></canvas>
<audio id="rain" preload="auto" loop playsinline>
  <source src="audio/night-forest-rain.mp3" type="audio/mpeg">
</audio>
<p class="sub">RAINDROPS — A moment in time</p>
<script>
// === CONFIG ===
const DROPS_TO_WIN = 10;
const RAIN_INT = 5;
const GLOW_MIN_GAP = 1000;
const GLOW_MAX_GAP = 3000;
const HIT_R = 80;
const DENSE = 12;
const IS_MOBILE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

// Guardrails for glowing drops - spawn between 15% and 85% of width
const GLOW_MIN_X = 0.15;
const GLOW_MAX_X = 0.85;

const QUOTES = [
  "The forest remembers what we forget.",
  "Even the tallest trees started as seeds.",
  "Be rooted. Be still. Be here.",
  "The rain feeds what the sun cannot.",
  "Listen — the trees are breathing.",
  "You are not lost. You are here.",
  "Nature does not hurry, yet everything is accomplished.",
  "The quietest places hold the deepest truths.",
  "Between the leaves, light finds a way.",
  "Rest now. The forest will keep watch.",
];

// === AUDIO ===
let actx=null,started=false;

function initAudio(){
  if(started) return;
  try{
    actx = new (window.AudioContext||window.webkitAudioContext)();
    started = true;
  }catch(e){}
}

// Harp-like pluck sound
function chime(){
  if(!actx)return;
  const notes=[392,440,523.2,587.3,659.2,784,880];
  const f=notes[Math.floor(Math.random()*notes.length)];
  const o=actx.createOscillator(),g=actx.createGain();
  o.type="triangle";o.frequency.value=f;
  g.gain.setValueAtTime(0.18,actx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01,actx.currentTime+0.5);
  g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+1.0);
  o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+1.0);
  const o2=actx.createOscillator(),g2=actx.createGain();
  o2.type="sine";o2.frequency.value=f*2;
  g2.gain.setValueAtTime(0.06,actx.currentTime);
  g2.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.4);
  o2.connect(g2);g2.connect(actx.destination);o2.start();o2.stop(actx.currentTime+0.4);
}

function playEnd(){
  if(!actx)return;
  // Fade out rain audio
  const rainEl=document.getElementById("rain");
  if(rainEl){
    let vol=rainEl.volume;
    const fade=setInterval(()=>{
      vol-=0.02;
      if(vol<=0.05){rainEl.volume=0.05;clearInterval(fade);}
      else rainEl.volume=vol;
    },100);
  }
  [261.6,329.6,392,523.2].forEach((f,i)=>{
    const o=actx.createOscillator(),g=actx.createGain();
    o.type="triangle";o.frequency.value=f;
    g.gain.setValueAtTime(0,actx.currentTime+i*0.3);
    g.gain.linearRampToValueAtTime(0.05,actx.currentTime+i*0.3+0.6);
    g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+i*0.3+4);
    o.connect(g);g.connect(actx.destination);o.start(actx.currentTime+i*0.3);o.stop(actx.currentTime+i*0.3+4);
  });
}

function resetRain(){
  const rainEl=document.getElementById("rain");
  if(!rainEl)return;
  rainEl.volume=IS_MOBILE?1.0:0.6;
  rainEl.muted=false;
}

// === CANVAS ===
const cv=document.getElementById("g"),c=cv.getContext("2d");

// roundRect fallback for Firefox/older browsers
if (!c.roundRect) {
  c.roundRect = function(x, y, w, h, r) {
    r = Math.min(r || 0, w / 2, h / 2);
    this.moveTo(x + r, y);
    this.arcTo(x + w, y,     x + w, y + h, r);
    this.arcTo(x + w, y + h, x,     y + h, r);
    this.arcTo(x,     y + h, x,     y,     r);
    this.arcTo(x,     y,     x + w, y,     r);
    this.closePath();
    return this;
  };
}

let sky=null;
let forest=null;

function resize(){
  const vw = window.innerWidth;
  const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
  
  // Full screen with small margin
  let w = vw * 0.99;
  let h = vh * 0.94;
  
  // Keep 16:9 aspect ratio
  const aspect = 16 / 9;
  if (w / h > aspect) {
    w = h * aspect;
  } else {
    h = w / aspect;
  }
  
  w = Math.floor(w);
  h = Math.floor(h);

  const scale = window.devicePixelRatio || 1;

  cv.width  = Math.floor(w * scale);
  cv.height = Math.floor(h * scale);

  cv.style.width  = w + "px";
  cv.style.height = h + "px";

  c.setTransform(scale, 0, 0, scale, 0, 0);

  sky = null;
  forest = null;
}
resize();
window.addEventListener("resize", resize);

// === FOREST TREES ===
function buildForest(w,h){
  const trees=[];
  for(let i=0;i<18;i++){
    trees.push({
      x:-20+Math.random()*(w+40),
      h:h*0.25+Math.random()*h*0.2,
      w:20+Math.random()*15,
      layer:0,
      shade:Math.random()*0.15,
    });
  }
  for(let i=0;i<12;i++){
    trees.push({
      x:-20+Math.random()*(w+40),
      h:h*0.35+Math.random()*h*0.25,
      w:25+Math.random()*20,
      layer:1,
      shade:Math.random()*0.1,
    });
  }
  for(let i=0;i<8;i++){
    trees.push({
      x:-10+Math.random()*(w+20),
      h:h*0.5+Math.random()*h*0.3,
      w:30+Math.random()*25,
      layer:2,
      shade:Math.random()*0.05,
    });
  }
  trees.sort((a,b)=>a.layer-b.layer);
  return trees;
}

function drawForest(w,h,t){
  if(!forest)forest=buildForest(w,h);
  const baseY=h;

  const fog=c.createLinearGradient(0,h*0.7,0,h);
  fog.addColorStop(0,"rgba(15,30,18,0)");
  fog.addColorStop(1,"rgba(15,30,18,0.3)");
  c.fillStyle=fog;c.fillRect(0,h*0.7,w,h*0.3);

  forest.forEach(tr=>{
    const darkness=[0.92,0.88,0.95][tr.layer];
    const green=[12,16,8][tr.layer];
    const alpha=darkness-tr.shade;

    const trunkW=tr.w*0.08+2;
    c.fillStyle=`rgba(${green-4},${green},${green-6},${alpha})`;
    c.fillRect(tr.x-trunkW/2,baseY-tr.h*0.4,trunkW,tr.h*0.4);

    c.fillStyle=`rgba(${green},${green+8},${green-2},${alpha})`;
    c.beginPath();
    c.ellipse(tr.x,baseY-tr.h*0.55,tr.w*0.5,tr.h*0.35,0,0,Math.PI*2);
    c.fill();
    c.beginPath();
    c.ellipse(tr.x-tr.w*0.1,baseY-tr.h*0.75,tr.w*0.3,tr.h*0.2,0,0,Math.PI*2);
    c.fill();
    c.beginPath();
    c.ellipse(tr.x+tr.w*0.2,baseY-tr.h*0.5,tr.w*0.25,tr.h*0.18,0,0,Math.PI*2);
    c.fill();

    if(tr.layer===1&&Math.sin(t*0.001+tr.x*0.1)>0.85){
      const fx=tr.x+Math.sin(t*0.002+tr.x)*15;
      const fy=baseY-tr.h*0.4+Math.cos(t*0.0015+tr.x)*10;
      c.fillStyle="rgba(200,230,100,0.3)";
      c.beginPath();c.arc(fx,fy,2,0,Math.PI*2);c.fill();
      const fg=c.createRadialGradient(fx,fy,0,fx,fy,8);
      fg.addColorStop(0,"rgba(200,230,100,0.12)");fg.addColorStop(1,"rgba(200,230,100,0)");
      c.fillStyle=fg;c.beginPath();c.arc(fx,fy,8,0,Math.PI*2);c.fill();
    }
  });

  c.fillStyle="rgba(10,20,12,0.8)";
  c.fillRect(0,baseY-3,w,5);

  const bushColors=["rgba(8,22,10,0.9)","rgba(12,28,14,0.85)","rgba(6,18,8,0.9)"];
  const bushes=[
    {x:w*0.05,r:32},{x:w*0.15,r:25},{x:w*0.28,r:36},
    {x:w*0.42,r:22},{x:w*0.55,r:29},{x:w*0.65,r:40},
    {x:w*0.78,r:24},{x:w*0.88,r:31},{x:w*0.95,r:27},
  ];
  bushes.forEach((b,i)=>{
    c.fillStyle=bushColors[i%bushColors.length];
    c.beginPath();c.ellipse(b.x,baseY-2,b.r,b.r*0.6,0,0,Math.PI*2);c.fill();
    c.beginPath();c.ellipse(b.x-b.r*0.5,baseY-1,b.r*0.6,b.r*0.4,0,0,Math.PI*2);c.fill();
    c.beginPath();c.ellipse(b.x+b.r*0.6,baseY,b.r*0.5,b.r*0.35,0,0,Math.PI*2);c.fill();
  });
}

// === GAME STATE ===
const gs={
  drops:[],catchPs:[],ripples:[],
  score:0,phase:"menu",
  lastRain:0,nextGlow:0,
  cloudOff:0,menuPulse:0,
  endT:0,endQuote:"",
  dimAlpha:0,rainFaded:false,rbPs:null,
};

function scheduleGlow(){
  gs.nextGlow=Date.now()+GLOW_MIN_GAP+Math.random()*(GLOW_MAX_GAP-GLOW_MIN_GAP);
}

function mkDrop(w,h,forceGlow){
  const gl=forceGlow||false;
  let xPos;
  if(gl){
    // Glowing drops spawn in middle area only (15% to 85% of width)
    xPos = w * GLOW_MIN_X + Math.random() * w * (GLOW_MAX_X - GLOW_MIN_X);
  } else {
    xPos = Math.random() * w;
  }
  return{
    x: xPos,
    y: -10 - Math.random() * 50,
    // Glowing drops slower, regular rain faster (like city scene)
    speed: gl ? 1.2 + Math.random() * 0.5 : 8.0 + Math.random() * 6.0,
    length: gl ? 18 + Math.random() * 10 : 3 + Math.random() * 8,
    opacity: gl ? 1 : 0.08 + Math.random() * 0.18,
    isGlowing: gl,
    pulsePhase: Math.random() * Math.PI * 2,
    width: gl ? 2.5 : 0.5 + Math.random() * 0.7,
    caught: false,
    fadeOut: 1,
    grounded: false,
    drift: (Math.random() - 0.5) * 0.15,
  };
}

function mkFx(x,y){
  const ps=[];
  for(let i=0;i<14;i++){
    const a=(Math.PI*2*i)/14+Math.random()*0.3,s=2+Math.random()*3;
    ps.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,life:1,size:1.5+Math.random()*3,
      color:Math.random()>0.5?"rgba(160,230,170,":"rgba(120,200,140,"});
  }
  return ps;
}

function mkRip(x,y){return{x,y,radius:3,opacity:0.45,speed:1};}

// === INPUT ===
function getPos(e){
  const r = cv.getBoundingClientRect();
  const px = e.touches ? e.touches[0].clientX : e.clientX;
  const py = e.touches ? e.touches[0].clientY : e.clientY;
  return { x: (px - r.left), y: (py - r.top) };
}

function tap(e){
  e.preventDefault();
  initAudio();

  const rainEl=document.getElementById("rain");
  if(rainEl){
    rainEl.volume=IS_MOBILE?1.0:0.6;
    rainEl.muted=false;
    rainEl.play().catch(err=>console.log("Rain play blocked:",err));
  }

  if(gs.phase==="menu"){
    gs.phase="playing";gs.score=0;
    gs.drops=[];gs.catchPs=[];gs.ripples=[];
    gs.endT=0;gs.dimAlpha=0;gs.rainFaded=false;gs.rbPs=null;
    forest=null;scheduleGlow();
    resetRain();lastTick=Date.now();return;
  }

  if(gs.phase==="quote"){
    gs.phase="menu";gs.score=0;forest=null;
    gs.dimAlpha=0;gs.rainFaded=false;gs.rbPs=null;resetRain();return;
  }

  if(gs.phase!=="playing")return;

  const{x,y}=getPos(e);
  let best=Infinity,bi=-1;
  for(let i=0;i<gs.drops.length;i++){
    const d=gs.drops[i];if(!d.isGlowing||d.caught)continue;
    const dist=Math.hypot(x-d.x,y-d.y);
    if(dist<HIT_R&&dist<best){best=dist;bi=i;}
  }
  if(bi>=0){
    const d=gs.drops[bi];d.caught=true;gs.score++;
    gs.catchPs.push(...mkFx(d.x,d.y));
    gs.ripples.push(mkRip(d.x,d.y));chime();
    if(gs.score>=DROPS_TO_WIN){
      gs.phase="ending";gs.endT=0;
      gs.endQuote=QUOTES[Math.floor(Math.random()*QUOTES.length)];
      playEnd();
    }
  } else {
    gs.ripples.push(mkRip(x,y));
  }
}

cv.addEventListener("click",tap);
cv.addEventListener("touchstart",tap,{passive:false});

// === DRAW DROP ===
function drawDrop(d){
  c.save();
  if(d.isGlowing&&!d.caught){
    d.pulsePhase+=0.04;const p=0.6+Math.sin(d.pulsePhase)*0.4;
    const og=c.createRadialGradient(d.x,d.y,0,d.x,d.y,32);
    og.addColorStop(0,`rgba(130,230,150,${0.22*p})`);og.addColorStop(0.4,`rgba(100,200,120,${0.08*p})`);og.addColorStop(1,"rgba(100,200,120,0)");
    c.fillStyle=og;c.beginPath();c.arc(d.x,d.y,32,0,Math.PI*2);c.fill();
    const ig=c.createRadialGradient(d.x,d.y,0,d.x,d.y,12);
    ig.addColorStop(0,`rgba(180,245,190,${0.45*p})`);ig.addColorStop(1,`rgba(130,230,150,${0.12*p})`);
    c.fillStyle=ig;c.beginPath();c.arc(d.x,d.y,12,0,Math.PI*2);c.fill();
    c.strokeStyle=`rgba(180,245,190,${0.8*d.fadeOut})`;c.lineWidth=d.width;c.lineCap="round";
    c.beginPath();c.moveTo(d.x,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();
    c.fillStyle=`rgba(255,255,255,${0.85*p*d.fadeOut})`;
    c.beginPath();c.arc(d.x,d.y,2.5,0,Math.PI*2);c.fill();
  } else {
    c.strokeStyle=`rgba(120,160,130,${d.opacity*d.fadeOut})`;c.lineWidth=d.width;c.lineCap="round";
    c.beginPath();c.moveTo(d.x+d.drift*5,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();
  }
  c.restore();
}

// === MAIN LOOP ===
let lastTick=Date.now();

function loop(){
  const now=Date.now();
  
  // Get canvas size from bounding rect (like city scene)
  const rect = cv.getBoundingClientRect();
  const cw = rect.width;
  const ch = rect.height;

  // === BG ===
  const bg=c.createLinearGradient(0,0,0,ch);
  bg.addColorStop(0,"#060e08");bg.addColorStop(0.3,"#0a1a0e");bg.addColorStop(1,"#0f2614");
  c.fillStyle=bg;c.fillRect(0,0,cw,ch);

  const isActive=gs.phase==="menu"||gs.phase==="playing"||gs.phase==="ending"||gs.phase==="quote";

  if(isActive){
    // Mist / cloud layer
    gs.cloudOff+=0.05;
    c.save();c.globalAlpha=0.15;c.fillStyle="rgba(20,35,22,1)";
    for(let i=0;i<3;i++){
      const cx2=((gs.cloudOff*(0.15+i*0.1)+i*180)%(cw+300))-150;
      c.beginPath();c.ellipse(cx2,15+i*12,110+i*25,12+i*4,0,0,Math.PI*2);c.fill();
    }
    c.restore();

    // Crescent moon
    const moonX=cw*0.82,moonY=ch*0.12,moonR=14;
    const mg=c.createRadialGradient(moonX,moonY,moonR*0.5,moonX,moonY,moonR*4);
    mg.addColorStop(0,"rgba(220,230,200,0.08)");mg.addColorStop(1,"rgba(220,230,200,0)");
    c.fillStyle=mg;c.beginPath();c.arc(moonX,moonY,moonR*4,0,Math.PI*2);c.fill();
    c.fillStyle="rgba(230,235,215,0.85)";
    c.beginPath();c.arc(moonX,moonY,moonR,0,Math.PI*2);c.fill();
    c.fillStyle="#060e08";
    c.beginPath();c.arc(moonX+8,moonY-2,moonR-1,0,Math.PI*2);c.fill();

    // Forest
    drawForest(cw,ch,now);

    // === RAIN SPAWNING ===
    const canSpawnRain=gs.phase==="playing"||gs.phase==="ending";
    const isMenu=gs.phase==="menu"||gs.phase==="quote";

    if(canSpawnRain&&now-gs.lastRain>RAIN_INT){
      for(let i=0;i<DENSE;i++) gs.drops.push(mkDrop(cw,ch,false));
      gs.lastRain=now;
    }
    if(isMenu&&now-gs.lastRain>100){
      for(let i=0;i<2;i++){const d=mkDrop(cw,ch,false);d.opacity=0.05+Math.random()*0.10;gs.drops.push(d);}
      gs.lastRain=now;
    }

    // Glow drop spawning
    if(gs.phase==="playing"&&now>=gs.nextGlow){
      gs.drops.push(mkDrop(cw,ch,true));
      scheduleGlow();
    }

    // Cap regular drops only
    const MAX_REGULAR = 500;
    let regularCount = 0;
    for (let i = gs.drops.length - 1; i >= 0; i--) {
      const d = gs.drops[i];
      if (!d.isGlowing) {
        regularCount++;
        if (regularCount > MAX_REGULAR) {
          gs.drops.splice(i, 1);
        }
      }
    }

    // Update & draw drops (same logic as city scene)
    for (let i = gs.drops.length - 1; i >= 0; i--) {
      const d = gs.drops[i];

      // Move
      d.y += d.speed;
      d.x += d.drift;

      // Mark "hit ground" when it passes the bottom
      if (!d.grounded && (d.y + d.length/2) >= (ch + 2)) {
        d.grounded = true;
      }

      // If caught, fade out
      if (d.caught) {
        d.fadeOut -= 0.08;
        if (d.fadeOut <= 0) {
          gs.drops.splice(i, 1);
          continue;
        }
      }

      // Glowing drops: only fade AFTER hitting the bottom
      if (d.isGlowing) {
        if (d.grounded) {
          d.fadeOut -= 0.04;
          if (d.fadeOut <= 0) {
            gs.drops.splice(i, 1);
            continue;
          }
        }
      } else {
        // Regular drops: remove once they go offscreen
        if (d.y > ch + 20) {
          gs.drops.splice(i, 1);
          continue;
        }
      }

      drawDrop(d);
    }

    // Ripples
    for(let i=gs.ripples.length-1;i>=0;i--){
      const r=gs.ripples[i];r.radius+=r.speed;r.opacity-=0.01;
      if(r.opacity<=0){gs.ripples.splice(i,1);continue;}
      c.save();c.strokeStyle=`rgba(130,200,140,${r.opacity})`;c.lineWidth=1;
      c.beginPath();c.arc(r.x,r.y,r.radius,0,Math.PI*2);c.stroke();c.restore();
    }

    // Catch particles
    for(let i=gs.catchPs.length-1;i>=0;i--){
      const p=gs.catchPs[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.04;p.life-=0.016;
      if(p.life<=0){gs.catchPs.splice(i,1);continue;}
      c.save();c.globalAlpha=p.life;c.fillStyle=p.color+p.life+")";
      c.beginPath();c.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);c.fill();c.restore();
    }
  }

  // === PLAYING UI ===
  if(gs.phase==="playing"){
    const barW=5,barH=ch*0.6,barX=12,barY=(ch-barH)/2;
    const prog=Math.min(gs.score/DROPS_TO_WIN,1);
    c.fillStyle="rgba(255,255,255,0.06)";
    c.beginPath();c.roundRect(barX,barY,barW,barH,3);c.fill();
    if(prog>0){
      const fillH=barH*prog;
      const fg=c.createLinearGradient(0,barY+barH,0,barY+barH-fillH);
      fg.addColorStop(0,"rgba(100,200,120,0.4)");fg.addColorStop(1,"rgba(160,240,170,0.7)");
      c.fillStyle=fg;c.beginPath();c.roundRect(barX,barY+barH-fillH,barW,fillH,3);c.fill();
      c.shadowColor="rgba(100,200,120,0.35)";c.shadowBlur=6;
      c.beginPath();c.roundRect(barX,barY+barH-fillH,barW,fillH,3);c.fill();c.shadowBlur=0;
    }
    c.fillStyle="rgba(255,255,255,0.65)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText(`${gs.score}`,barX+barW/2,barY+barH+18);
  }

  // === MENU ===
  if(gs.phase==="menu"){
    gs.menuPulse+=0.018;
    c.fillStyle="rgba(6,14,8,0.45)";c.fillRect(0,ch*0.28,cw,ch*0.42);
    c.fillStyle="rgba(200,245,210,0.9)";c.font="600 32px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("raindrops",cw/2,ch/2-22);
    c.fillStyle=`rgba(160,230,170,${0.5+Math.sin(gs.menuPulse)*0.2})`;
    c.font="600 15px 'Helvetica Neue',sans-serif";c.fillText("tap to begin",cw/2,ch/2+10);
    c.fillStyle="rgba(160,220,170,0.4)";c.font="12px 'Helvetica Neue',sans-serif";
    c.fillText("catch the glowing drops",cw/2,ch/2+32);
    c.fillStyle="rgba(160,220,170,0.3)";c.font="11px 'Helvetica Neue',sans-serif";
    c.fillText("forest",cw/2,ch/2+52);
  }

  // === ENDING SEQUENCE ===
  if(gs.phase==="ending"){
    gs.endT+=0.005;
    const t=Math.min(gs.endT,1);

    gs.rainFaded=true;

    const r1=Math.floor(6+(240-6)*t),g1=Math.floor(14+(253-14)*t),b1=Math.floor(8+(244-8)*t);
    const r2=Math.floor(15+(220-15)*t),g2=Math.floor(38+(247-38)*t),b2=Math.floor(20+(195-20)*t);
    const tbg=c.createLinearGradient(0,0,0,ch);
    tbg.addColorStop(0,`rgb(${r1},${g1},${b1})`);tbg.addColorStop(1,`rgb(${r2},${g2},${b2})`);
    c.fillStyle=tbg;c.fillRect(0,0,cw,ch);

    for(let i=gs.drops.length-1;i>=0;i--){
      const d=gs.drops[i];d.opacity*=0.95;d.speed*=0.98;
      if(d.opacity<0.003){gs.drops.splice(i,1);continue;}
      c.save();c.strokeStyle=`rgba(150,190,155,${d.opacity})`;c.lineWidth=d.width;c.lineCap="round";
      c.beginPath();c.moveTo(d.x,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();c.restore();
      d.y+=d.speed;
    }

    if(t>0.3){
      if(!gs.rbPs||gs.rbPs.length===0){
        gs.rbPs=[];
        const cols=["#22c55e","#86efac","#fbbf24","#a3e635","#34d399","#bbf7d0","#fef08a"];
        for(let i=0;i<120;i++)gs.rbPs.push({
          x:Math.random()*cw,y:Math.random()*ch,size:3+Math.random()*7,
          color:cols[Math.floor(Math.random()*cols.length)],
          speed:0.2+Math.random()*0.6,wobble:Math.random()*Math.PI*2,
          wobbleSpd:0.01+Math.random()*0.02,opacity:0,
          target:0.3+Math.random()*0.5,shape:Math.random()>0.5?"c":"d",
        });
      }
      const po=(t-0.3)/0.7;
      gs.rbPs.forEach(p=>{
        p.wobble+=p.wobbleSpd;p.y-=p.speed*0.4;p.x+=Math.sin(p.wobble)*0.4;
        if(p.y<-10)p.y=ch+10;
        c.save();c.globalAlpha=p.target*po*0.6;c.fillStyle=p.color;
        if(p.shape==="c"){c.beginPath();c.arc(p.x,p.y,p.size,0,Math.PI*2);c.fill();}
        else{c.translate(p.x,p.y);c.rotate(Math.PI/4);c.fillRect(-p.size/2,-p.size/2,p.size,p.size);}
        c.restore();
      });
    }

    if(t>0.6){
      c.save();c.globalAlpha=Math.min((t-0.6)/0.3,1)*0.5;
      c.fillStyle="rgba(40,100,50,1)";c.font="600 22px 'Helvetica Neue',sans-serif";
      c.textAlign="center";c.fillText("stillness",cw/2,ch/2-10);c.restore();
    }

    if(gs.endT>1.3)gs.phase="quote";
  }

  // === QUOTE SCREEN ===
  if(gs.phase==="quote"){
    const rg=c.createLinearGradient(0,0,0,ch);
    rg.addColorStop(0,"#f0fdf4");rg.addColorStop(0.35,"#bbf7d0");rg.addColorStop(0.65,"#dcfce7");rg.addColorStop(1,"#fef9c3");
    c.fillStyle=rg;c.fillRect(0,0,cw,ch);

    const sx=cw*0.6,sy=ch*0.18;
    const sg=c.createRadialGradient(sx,sy,0,sx,sy,100);
    sg.addColorStop(0,"rgba(180,230,80,0.6)");sg.addColorStop(0.3,"rgba(180,230,80,0.2)");sg.addColorStop(1,"rgba(180,230,80,0)");
    c.fillStyle=sg;c.beginPath();c.arc(sx,sy,100,0,Math.PI*2);c.fill();
    c.fillStyle="rgba(255,255,255,0.8)";c.beginPath();c.arc(sx,sy,20,0,Math.PI*2);c.fill();

    const arcY=ch*1.6,arcR=cw*0.9;
    ["#22c55e","#86efac","#fbbf24","#a3e635","#34d399","#6ee7b7"].forEach((col,i)=>{
      c.save();c.strokeStyle=col;c.globalAlpha=0.3;c.lineWidth=12;
      c.beginPath();c.arc(cw*0.5,arcY,arcR+i*14,Math.PI+0.15,Math.PI*2-0.15);c.stroke();c.restore();
    });

    if(gs.rbPs)gs.rbPs.forEach(p=>{
      p.wobble+=p.wobbleSpd;p.y-=p.speed*0.25;p.x+=Math.sin(p.wobble)*0.3;
      if(p.opacity<p.target)p.opacity+=0.008;
      if(p.y<-10){p.y=ch+10;p.x=Math.random()*cw;}
      c.save();c.globalAlpha=p.opacity;c.fillStyle=p.color;
      if(p.shape==="c"){c.beginPath();c.arc(p.x,p.y,p.size,0,Math.PI*2);c.fill();}
      else{c.translate(p.x,p.y);c.rotate(Math.PI/4);c.fillRect(-p.size/2,-p.size/2,p.size,p.size);}
      c.restore();
    });

    c.save();
    const words=gs.endQuote.split(" ");
    let lines=[],line="";
    words.forEach(w=>{const test=line?line+" "+w:w;if(test.length>22){lines.push(line);line=w;}else line=test;});
    if(line)lines.push(line);
    const lh=32,qtH=lines.length*lh+36,qtW=cw*0.85,qtX=(cw-qtW)/2,qtY=ch/2-qtH/2-10;
    c.fillStyle="rgba(255,255,255,0.4)";
    c.beginPath();c.roundRect(qtX,qtY,qtW,qtH,14);c.fill();
    c.fillStyle="rgba(25,80,40,0.9)";
    c.font="italic 600 22px 'Helvetica Neue',sans-serif";
    c.textAlign="center";
    lines.forEach((l,i)=>c.fillText(l,cw/2,qtY+28+i*lh));
    c.restore();

    const btnW=140,btnH=34,btnX=(cw-btnW)/2,btnY=ch-55;
    c.fillStyle="rgba(255,255,255,0.3)";
    c.beginPath();c.roundRect(btnX,btnY,btnW,btnH,17);c.fill();
    c.fillStyle="rgba(25,80,40,0.7)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("tap to continue",cw/2,btnY+btnH/2+4);
  }

  requestAnimationFrame(loop);
}

scheduleGlow();
requestAnimationFrame(loop);
</script>
</body>
</html>
